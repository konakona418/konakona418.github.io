<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>新年，以及「特别的气氛」</title>
    <link href="/2026/01/01/%E6%96%B0%E5%B9%B4%EF%BC%8C%E4%BB%A5%E5%8F%8A%E3%80%8C%E7%89%B9%E5%88%AB%E7%9A%84%E6%B0%94%E6%B0%9B%E3%80%8D/"/>
    <url>/2026/01/01/%E6%96%B0%E5%B9%B4%EF%BC%8C%E4%BB%A5%E5%8F%8A%E3%80%8C%E7%89%B9%E5%88%AB%E7%9A%84%E6%B0%94%E6%B0%9B%E3%80%8D/</url>
    
    <content type="html"><![CDATA[<p>今年大致可以被总结为「三不两无一没有」。这个总结法还是我老汉发明的。</p><p><strong>三不：</strong> 上课不听讲、有空不运动、到点不睡觉。</p><p><strong>两无</strong>：无文化、无对象。</p><p><strong>一没有：</strong> 没有希望。</p><p>……</p><p>以及，今天西安下雪了，有一种特别的气氛。虽然我没有女朋友。</p><p><img src="/img/post/2026-01/01/01.jpg"></p><p>于是便在如此这般「特别的气氛」中迎来了 21 世纪的四分之一的终结。</p><p>那么，新年快乐。</p>]]></content>
    
    
    
    <tags>
      
      <tag>日常</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>【短评】即便如此东大村依然转动</title>
    <link href="/2025/12/24/%E3%80%90%E7%9F%AD%E8%AF%84%E3%80%91%E5%8D%B3%E4%BE%BF%E5%A6%82%E6%AD%A4%E4%B8%9C%E5%A4%A7%E6%9D%91%E4%BE%9D%E7%84%B6%E8%BD%AC%E5%8A%A8/"/>
    <url>/2025/12/24/%E3%80%90%E7%9F%AD%E8%AF%84%E3%80%91%E5%8D%B3%E4%BE%BF%E5%A6%82%E6%AD%A4%E4%B8%9C%E5%A4%A7%E6%9D%91%E4%BE%9D%E7%84%B6%E8%BD%AC%E5%8A%A8/</url>
    
    <content type="html"><![CDATA[<h2 id="关于日常动画"><a href="#关于日常动画" class="headerlink" title="关于日常动画"></a>关于日常动画</h2><p>不妨拣几个比较典型的日常动画来研究。</p><ul><li><p>《日常》是反-日常动画。因为很显然，看过《日常》的人都会认为其内容实际上并不日常。标题欺诈说是。</p></li><li><p>《凉宫春日的忧郁》是反-日常的日常动画。</p></li><li><p><strong>《女仆咖啡厅》（《即便如此小镇依然转动》）是反-反-日常的日常动画。</strong></p></li></ul><p>之所以说女仆咖啡厅是日常动画，是因为剧情并没有太大的波折——就算有最后也包饺子了。尽管时常有反-日常的事情发生在主角步鸟身上，但是这些事情最后基本都被化解了，最后大家还是回归到了一贯的日常去。那么步鸟在经历这些事情后有没有什么变化呢？看起来，不管经历什么事情，步鸟似乎还是一如既往的那个”不会生病的笨蛋“。动画的最后一话里面步鸟被一个货车创昏迷了过去，升上了某种类似天国的地方 <del>天国大魔境</del> 。在这个”天国“里面，步鸟看到了其他人对自己出事故这件事情的巨大悲伤，不禁大哭道”不会这么不成熟了“，这时候她似乎已经和之前那个带着笨蛋气质的女孩完全不沾边了，这时候”天国“的工作人员说我们搞错了，现在我们要把你抹除记忆送回去。然后步鸟醒来，第一句话却是大声质问道”这又是什么新的恶作剧吗！？“看起来，她又变回到了之前那个笨蛋，但或许大家喜欢的就是一如往常的那个作为笨蛋的、有点可爱的她呢？所以说，这个作品是拒斥反-日常的，那也就是反-反-日常喽，反-反-日常不否认反-日常本身的存在，只是拒绝反-日常对日常结构的破坏性。作品承认反-日常的存在，但是它没有让反-日常让叙事线产生重大的改变。而作为观众的我们，畏惧的也不是反-日常本身，而是哪次反-日常以后却没有对应的反-反-日常发生了。</p><p>我并不认为反-反-日常是什么对运动或者变化的排斥。实际上小镇和小镇里的人，包括步鸟她自己，难道就一点变化都没有吗？缓慢但是确实存在的某种变化是的的确确地发生了——而 <strong>即便如此，小镇依然转动。</strong> </p><p>我感觉我们不知不觉中就浸淫在类似的某种变化中，似乎是无可奈何地滑向未来而不自知。直到未来的某一天，大家看到以前的照片或者什么文字记录之类的，突然发现怎么周围的事情都变得面目全非了。</p><p>大概是我上小学的时候的某次元旦还是春节，好像是 14 年，我突然意识到我不能再经历一次 2014 年，世界上所有人都不能。但是好像我们没法做任何事情。至于什么国际局势之类的很龙的事情，现在有个智能手机的人都能去置喙，但是实际上大部分人包括我，不管嘴炮多少，还是没法 <em>直接</em> 干涉这些东西中的任何一部分的，最后还是只能始于嘴炮终于嘴炮，我想他们这时候感到的应该是一种巨大的无力感。尽管有些人老是在网上说要这样那样的，但是说不定哪天告诉他，他美好的现代生活就要消失了，欢迎来到后现代！这时候他估计也不乐意了。可能他恐惧的也不是例外状态），因为他每天都能看到例外状态的事情发生在世界各地（甚至自己周围乃至自己身上），而人是不会对自己每天都能见到的东西感到恐惧的，见多了都祛魅了。他恐惧的是，例外状态来了以后就赖着不走了，例外状态变成新的常态了，唉 good old days，你在哪？</p><p>我记得 20 年的时候，当时呆在家里面还感觉新奇好玩，不用上学了，打游戏真TM爽啊！这个例外状态真不赖，要是能一直持续下去就好了。然而到了 22 年的时候我就完全麻掉了，因为例外状态疑似有点太长了，长到我的游戏已经打到无聊，不禁怀念起虽然更无聊更傻X但是已经很久没有体验过的所谓”完全正常“的学校生活了。22 年 10 月份某天早上学校突然封了不进不出，我一大早跑去，门卫大爷说同学回去吧。然后我说，靠，然后掉头就跑，真讨厌，我简直受够了。学校在拒斥我的进入，要是我再也进不去了也挺好。然而不幸的，学校只是暂时拒斥我的进入。但是什么时候我才能进去，回去上学？那就不知道了，这才是这个事情里最恶心的地方。不能预测的事情，超出认知的事情，<strong>没有结尾的反日常</strong> 的事情。</p><p>不过好在看起来最后大家还是回归了日常。然后西工大明天还是一如既往地转动，东大村和西安市也是，我自己也是，毛主席也说了，”坐地日行八万里“。我明天起来还要写代码，说到这里，虽然我确实做不到很多事情，但我到底还是可以做到一些别的事情的，比如写代码，虽然老实说我对这方面的能力不算太自信。</p><p>即便如此世界依然转动，这时候当个笨蛋也挺好，毕竟笨蛋是不会生病的。不过鉴于某个笨蛋明天还要早起写代码，因此他现在准备睡觉。</p><p><img src="/img/post/2025-12/02/01.jpg"></p><blockquote><p>Spock 是大副啊 kora，字幕组！</p></blockquote>]]></content>
    
    
    
    <tags>
      
      <tag>杂谈</tag>
      
      <tag>动画</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>成功被 OpenAL 气笑，其次是被自己气笑</title>
    <link href="/2025/12/05/%E6%88%90%E5%8A%9F%E8%A2%AB-OpenAL-%E6%B0%94%E7%AC%91%EF%BC%8C%E5%85%B6%E6%AC%A1%E6%98%AF%E8%A2%AB%E8%87%AA%E5%B7%B1%E6%B0%94%E7%AC%91/"/>
    <url>/2025/12/05/%E6%88%90%E5%8A%9F%E8%A2%AB-OpenAL-%E6%B0%94%E7%AC%91%EF%BC%8C%E5%85%B6%E6%AC%A1%E6%98%AF%E8%A2%AB%E8%87%AA%E5%B7%B1%E6%B0%94%E7%AC%91/</url>
    
    <content type="html"><![CDATA[<p>哦牛批原来这个 OpenAL 找不到动态链接库就会 fallback 到什么上古 Audio Device 的，给我气笑了，整了一下午排查什么没归一化什么同步问题，最后发现是这个原因，我还能说什么呢。</p>]]></content>
    
    
    
    <tags>
      
      <tag>C++</tag>
      
      <tag>音视频处理</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>【旧文】通软“智慧校园”系统修改与自定义技巧</title>
    <link href="/2025/12/05/%E3%80%90%E6%97%A7%E6%96%87%E3%80%91%E9%80%9A%E8%BD%AF%E2%80%9C%E6%99%BA%E6%85%A7%E6%A0%A1%E5%9B%AD%E2%80%9D%E7%B3%BB%E7%BB%9F%E4%BF%AE%E6%94%B9%E4%B8%8E%E8%87%AA%E5%AE%9A%E4%B9%89%E6%8A%80%E5%B7%A7/"/>
    <url>/2025/12/05/%E3%80%90%E6%97%A7%E6%96%87%E3%80%91%E9%80%9A%E8%BD%AF%E2%80%9C%E6%99%BA%E6%85%A7%E6%A0%A1%E5%9B%AD%E2%80%9D%E7%B3%BB%E7%BB%9F%E4%BF%AE%E6%94%B9%E4%B8%8E%E8%87%AA%E5%AE%9A%E4%B9%89%E6%8A%80%E5%B7%A7/</url>
    
    <content type="html"><![CDATA[<blockquote><p>高中时候写的文章，现在搬过来。</p></blockquote><p><strong>说在前面：本备忘的内容均以电子班牌系统为例进行介绍。</strong></p><h1 id="一、插件系统"><a href="#一、插件系统" class="headerlink" title="一、插件系统"></a>一、插件系统</h1><h2 id="0-概论"><a href="#0-概论" class="headerlink" title="0. 概论"></a>0. 概论</h2><p>通软公司的统一开发框架支持且只支持一种基于插件的开发。如此操作似乎是有着解耦合与代码复用方面的考量（例如刷卡组件便是电子班牌与校门口刷卡门岗共用）。</p><p>在这种指导思想的引领下，通软的任何一套系统的“主程序”只能被称为是一个插件加载器，而所有的业务逻辑、UI 等等全部被拆散在了一个一个 .Net Framework 类库中。</p><p>固然，这种设计模式有着一定的合理性，并的确实现了通软的同志们所希冀的解耦合与复用性，但是也给第三者对其系统的修改带来了极大的便利。实际上，接下来的一切修改，都是基于插件系统进行的。</p><p>以下，将介绍通软的插件系统的基本内容。</p><h2 id="1-一套插件的基本组成部分"><a href="#1-一套插件的基本组成部分" class="headerlink" title="1. 一套插件的基本组成部分"></a>1. 一套插件的基本组成部分</h2><p>一般说来，一个插件最少应当包含以下几个组成部分：</p><ol><li>至少一个 .Net Framework <code>.dll</code> 类库；</li><li>一个对插件基本的结构进行描述的 <code>Mapper.xml</code> 文件；</li><li>一个保存着插件配置的 <code>Config.xml</code> 文件。</li></ol><h3 id="a-类库"><a href="#a-类库" class="headerlink" title="a. 类库"></a>a. 类库</h3><p>见后文。</p><h3 id="b-Mapper-xml"><a href="#b-Mapper-xml" class="headerlink" title="b. Mapper.xml"></a>b. Mapper.xml</h3><p><code>Mapper.xml</code> 对插件的基本内容进行了描述。以下是一个案例（<code>/GS.Terminal.SmartBoard.Logic/Mapper.xml</code>）:</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;utf-8&quot;</span> ?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">Extensibility</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;urn:Chinags-Extensibility-1.0&quot;</span> <span class="hljs-attr">Name</span>=<span class="hljs-string">&quot;智能班牌逻辑插件&quot;</span> <span class="hljs-attr">SymbolicName</span>=<span class="hljs-string">&quot;GS.Terminal.SmartBoard.Logic&quot;</span> <span class="hljs-attr">Version</span>=<span class="hljs-string">&quot;3.4.2.62&quot;</span> <span class="hljs-attr">StartLevel</span>=<span class="hljs-string">&quot;41&quot;</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">License</span>&gt;</span>nX8iVjYNw97wiLmepVhiT...(略)<span class="hljs-tag">&lt;/<span class="hljs-name">License</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">Activator</span> <span class="hljs-attr">Type</span>=<span class="hljs-string">&quot;GS.Terminal.SmartBoard.Logic.Program&quot;</span>/&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">Runtime</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">Assembly</span> <span class="hljs-attr">Path</span>=<span class="hljs-string">&quot;GS.Terminal.SmartBoard.Logic.dll&quot;</span> <span class="hljs-attr">Share</span>=<span class="hljs-string">&quot;true&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">Assembly</span> <span class="hljs-attr">Path</span>=<span class="hljs-string">&quot;GS.Terminal.SmartBoard.LocalDB.dll&quot;</span> <span class="hljs-attr">Share</span>=<span class="hljs-string">&quot;false&quot;</span>/&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">Runtime</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">ObjectSpaces</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">Channel</span> <span class="hljs-attr">ConnectionName</span>=<span class="hljs-string">&quot;sqlite&quot;</span> <span class="hljs-attr">ModelAssembly</span>=<span class="hljs-string">&quot;GS.Terminal.SmartBoard.LocalDB&quot;</span> <span class="hljs-attr">Name</span>=<span class="hljs-string">&quot;sqlite&quot;</span>/&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">ObjectSpaces</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">Services</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">Service</span> <span class="hljs-attr">TypeAndName</span>=<span class="hljs-string">&quot;GS.Terminal.SmartBoard.Logic.Core.Service&quot;</span> <span class="hljs-attr">Caption</span>=<span class="hljs-string">&quot;与服务通讯实时接收推送&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">Service</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">Service</span> <span class="hljs-attr">TypeAndName</span>=<span class="hljs-string">&quot;GS.Terminal.SmartBoard.Logic.Core.AdministratorService&quot;</span> <span class="hljs-attr">Caption</span>=<span class="hljs-string">&quot;管理员相关服务&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">Service</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">Services</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">Extensibility</span>&gt;</span><br></code></pre></td></tr></table></figure><p>这里就关键的几点进行解释：</p><ol><li><code>Name</code> 与 <code>SymbolicName</code> 字段：前者不重要，后者<strong>必须</strong>与存储插件的文件夹名称一致。</li><li><code>StartLevel</code> 字段：该字段的值越小，启动越早。建议破解插件在通软规定的“其他插件” <code>StartLevel</code> 段（≥80）启动，以避免潜在的依赖关系问题。</li><li><code>License</code> 字段：插件的证书。后文会对此进行详细解释。<strong>此字段欠缺会导致插件被拒绝加载！</strong></li><li><code>Activator</code> 字段：一个实现了 <code>GS.Unitive.Framework.Core.IAddonActivator</code> 接口的类。后文会对此进行详细解释。</li><li><code>Runtime/Assembly</code> 字段：即 <code>.dll</code> 类库的文件名。<code>shared</code> 的真伪决定了能否在别的插件中创建该类库中某个类的实例（不重要）。</li><li><code>ObjectSpaces</code> 字段：实际用途暂不明确，可能与本地数据库读写相关。</li><li><code>Services</code> 字段：将类库中的某些类注册为一系列可以从其他插件中读取并调用其方法的“服务”。服务系统是插件系统中非常关键的一部分。</li></ol><p>如果这个文件没有正常配置，插件是无法加载的。</p><h3 id="c-Config-xml"><a href="#c-Config-xml" class="headerlink" title="c. Config.xml"></a>c. Config.xml</h3><p><code>Config.xml</code> 相当于插件的配置文件。形如：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;utf-8&quot;</span> ?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">Settings</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;urn:Chinags-Configuration&quot;</span> <span class="hljs-attr">AddonName</span>=<span class="hljs-string">&quot;GS.Terminal.Theme&quot;</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">Dictionaries</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">Dict</span> <span class="hljs-attr">Name</span>=<span class="hljs-string">&quot;Theme&quot;</span> <span class="hljs-attr">Caption</span>=<span class="hljs-string">&quot;默认主题&quot;</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">Key</span> <span class="hljs-attr">Caption</span>=<span class="hljs-string">&quot;主题名称&quot;</span> <span class="hljs-attr">Choice</span>=<span class="hljs-string">&quot;&quot;</span> <span class="hljs-attr">Name</span>=<span class="hljs-string">&quot;ThemeName&quot;</span> <span class="hljs-attr">Value</span>=<span class="hljs-string">&quot;Default&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">Dict</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">Dictionaries</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">Settings</span>&gt;</span><br></code></pre></td></tr></table></figure><ol><li><code>AddonName</code> 字段：与 <code>AddonSymbolicName</code> 一致。</li><li><code>Dictionaries</code> 与 <code>Key</code>：相当于是一系列键值对。具体使用后文会解释。</li></ol><h2 id="2-插件中类库的具体结构"><a href="#2-插件中类库的具体结构" class="headerlink" title="2. 插件中类库的具体结构"></a>2. 插件中类库的具体结构</h2><p>尽管在反编译当中会发现通软自己的插件中有着巨大多命名空间和类，但是实际上大部分的内容都是用来实现各种业务逻辑的。一般说来，一个最基本的插件最多只需要包含以下内容：</p><ol><li>一个实现了 <code>GS.Unitive.Framework.Core.IAddonActivator</code> 接口的 <em>激活器</em> 类（名称不一定是这个）。该类应当在 <code>Mapper.xml</code> 的 <code>Activator</code> 字段中被注册。例如，对于命名空间 <code>MyProject.MyNamespace</code> 下一个类 <code>MyActivator</code>，应当这样写：</li></ol><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">Activator</span> <span class="hljs-attr">Type</span>=<span class="hljs-string">&quot;MyProject.MyNamespace.MyActivator&quot;</span>/&gt;</span><br></code></pre></td></tr></table></figure><ol start="2"><li><code>Service</code> 服务类。名称可以任取（当然为了可读性方面的考虑建议以 <code>Service</code> 结尾）。其应当在 <code>Mapper.xml</code> 的 <code>Services</code> 字段中被注册。例如，对于命名空间 <code>MyProject.MyNamespace</code> 下一个类 <code>MyService</code>，应当这样写：</li></ol><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">Services</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">Service</span> </span><br><span class="hljs-tag">    <span class="hljs-attr">TypeAndName</span>=<span class="hljs-string">&quot;MyProject.MyNamespace.MyService&quot;</span> </span><br><span class="hljs-tag">    <span class="hljs-attr">Caption</span>=<span class="hljs-string">&quot;我的服务&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">Service</span>&gt;</span><br>    <span class="hljs-comment">&lt;!--其他的 Service 以此类推--&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">Services</span>&gt;</span><br></code></pre></td></tr></table></figure><p>注册后，就可以在别的插件调用 <code>MyService</code> 里面的方法了，详见后文。</p><h2 id="3-插件内部运作与插件间交互的基本操作"><a href="#3-插件内部运作与插件间交互的基本操作" class="headerlink" title="3. 插件内部运作与插件间交互的基本操作"></a>3. 插件内部运作与插件间交互的基本操作</h2><p>主要介绍以下三点：插件的启停、插件数据相关、插件服务的调用。</p><h3 id="a-插件的启停"><a href="#a-插件的启停" class="headerlink" title="a. 插件的启停"></a>a. 插件的启停</h3><p>前面说到，插件应当包含一个实现了 <code>GS.Unitive.Framework.Core.IAddonActivator</code> 接口的激活器类。该类应当实现其 <code>Start(IAddonContext)</code> 及 <code>Stop(IAddonContext)</code> 方法。这两个方法分别会在插件启动&#x2F;停止时被调用。</p><p>比如这样写：</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">using</span> System; <span class="hljs-comment">// 注：其他 .Net 模块为避免赘余不再写出。</span><br><br><span class="hljs-keyword">using</span> GS.Unitive.Framework.Core;<br><span class="hljs-keyword">using</span> GS.Unitive.Framework.Persistent;<br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title">MyProject.MyNamespace</span><br>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">MyActivator</span> : <span class="hljs-title">IAddonActivator</span><br>    &#123;<br>        <span class="hljs-keyword">public</span> IAddonContext addonContext;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Start</span>(<span class="hljs-params">IAddonContext context</span>)</span><br>        &#123;<br>            <span class="hljs-keyword">this</span>.addonContext = context;<br>            <span class="hljs-keyword">this</span>.addonContext.Logger.Info(<span class="hljs-string">&quot;成功加载插件&quot;</span>);<br>            <span class="hljs-comment">// IAddonContext.Logger 为公用日志工具</span><br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Stop</span>(<span class="hljs-params">IAddonContext context</span>)</span><br>        &#123;<br>            <span class="hljs-comment">// 停止时执行的内容，如终止 UDP 监听等。</span><br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>这样，便可以实现基本的插件启停。</p><h3 id="b-插件数据相关"><a href="#b-插件数据相关" class="headerlink" title="b. 插件数据相关"></a>b. 插件数据相关</h3><p>首先介绍对插件配置的读取。</p><p>假如我们的插件有这样一个配置文件：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;utf-8&quot;</span> ?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">Settings</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;urn:Chinags-Configuration&quot;</span> <span class="hljs-attr">AddonName</span>=<span class="hljs-string">&quot;MyProject&quot;</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">Dictionaries</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">Dict</span> <span class="hljs-attr">Name</span>=<span class="hljs-string">&quot;baseConfig&quot;</span> <span class="hljs-attr">Caption</span>=<span class="hljs-string">&quot;基础配置&quot;</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">Key</span> </span><br><span class="hljs-tag">      <span class="hljs-attr">Caption</span>=<span class="hljs-string">&quot;第一个&quot;</span> </span><br><span class="hljs-tag">      <span class="hljs-attr">Choice</span>=<span class="hljs-string">&quot;&quot;</span> </span><br><span class="hljs-tag">      <span class="hljs-attr">Name</span>=<span class="hljs-string">&quot;Key1&quot;</span> </span><br><span class="hljs-tag">      <span class="hljs-attr">Value</span>=<span class="hljs-string">&quot;Value1&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">Dict</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">Dictionaries</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">Settings</span>&gt;</span><br></code></pre></td></tr></table></figure><p>那么，想要获取 <code>baseConfig</code> 中 <code>Key1</code> 的值，便可以这样写：</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-comment">// addonContext : IAddonContext</span><br><span class="hljs-built_in">string</span> value1 = addonContext.DictionaryValue(<span class="hljs-string">&quot;baseConfig&quot;</span>, <span class="hljs-string">&quot;Key1&quot;</span>);<br></code></pre></td></tr></table></figure><p>另外，如果没有找到 <code>Key1</code>，则会返回 <code>null</code>。</p><p>然后介绍创建和读取交互式数据。</p><p>交互式数据一经创建，便可由任何插件读取。</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-built_in">object</span> data = somedata;<br>addonContext.IntercativeData&lt;<span class="hljs-built_in">object</span>&gt;(<span class="hljs-string">&quot;DataKey&quot;</span>, data);<br><span class="hljs-comment">// 创建。泛型尖括号里面填数据值的类型。</span><br><span class="hljs-built_in">dynamic</span> result = addonContext.IntercativeData(<span class="hljs-string">&quot;DataKey&quot;</span>);<br><span class="hljs-comment">// 读取</span><br><span class="hljs-built_in">object</span> newdata = somedata;<br>addonContext.IntercativeData&lt;<span class="hljs-built_in">object</span>&gt;(<span class="hljs-string">&quot;DataKey&quot;</span>, newdata);<br><span class="hljs-comment">// 修改。泛型尖括号里面填数据值的类型。</span><br></code></pre></td></tr></table></figure><h3 id="c-插件服务调用"><a href="#c-插件服务调用" class="headerlink" title="c. 插件服务调用"></a>c. 插件服务调用</h3><p>对于其他插件已经注册了的服务，可以通过以下方法进行调用：</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-built_in">dynamic</span> service = <span class="hljs-keyword">this</span>.addonContext.GetFirstOrDefaultService(<span class="hljs-string">&quot;GS.Terminal.MainShell&quot;</span>, <span class="hljs-string">&quot;GS.Terminal.MainShell.Services.UIService&quot;</span>);<br><span class="hljs-comment">// 第一个参数为 AddonSymbolicName，第二个为 typeof(Service) 的字符串形式（即 Mapper.xml 中 Services/Service.TypeAndName）。</span><br><br><span class="hljs-comment">// KnownTypeName service = this.addonContext.GetFirstOrDefaultService&lt;KnownTypeName&gt;(addonSymbolicName);</span><br><span class="hljs-comment">// 在 Service 类型已知的情况下，也可以这样写。</span><br><br><span class="hljs-comment">// service.SomeMethod(); </span><br><span class="hljs-comment">// 比如这里便是用 GS.Terminal.MainShell 的相关方法注册一个管理员指令，输入后会显示一个弹窗：</span><br>service.RegistBackgroundCommand(<span class="hljs-string">&quot;0&quot;</span>, <span class="hljs-keyword">new</span> Action(<br>    () =&gt;<br>    &#123;<br>        service.ShowPrompt(<span class="hljs-string">&quot;Fuck GS!!&quot;</span>, <span class="hljs-number">10</span>);<br>    &#125;<br>));<br></code></pre></td></tr></table></figure><p>注意，如果指定的服务不存在，则会返回 <code>null</code>。</p><h2 id="4-常用的服务"><a href="#4-常用的服务" class="headerlink" title="4. 常用的服务"></a>4. 常用的服务</h2><ul><li><code>GS.Terminal.TimeLine</code> 任务计划与定时执行相关；</li><li><code>GS.Terminal.GarnitureControl</code> 创建浮窗等；</li><li><code>GS.Terminal.DeviceManager</code> 管理读卡器等外设；</li><li><code>GS.Terminal.MainShell.</code><strong><code>Services.UIService</code></strong> 管理用户界面；</li></ul><h2 id="5-基本插件案例"><a href="#5-基本插件案例" class="headerlink" title="5. 基本插件案例"></a>5. 基本插件案例</h2><p>通软在很多服务中都大量使用了 <code>dynamic</code> 动态类型。以下将以读卡器使用为例介绍。</p><h3 id="a-读卡器的使用"><a href="#a-读卡器的使用" class="headerlink" title="a. 读卡器的使用"></a>a. 读卡器的使用</h3><p>以下代码在刷卡时会调用 <code>DoSomething(string)</code> 函数，并传入卡号作为参数。</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-comment">// IAddonContext addonContext;</span><br><span class="hljs-built_in">dynamic</span> device = addonContext.GetFirstOrDefaultService(<span class="hljs-string">&quot;GS.Terminal.DeviceManager&quot;</span>,<span class="hljs-string">&quot;GS.Terminal.DeviceManager.Service.DeviceCallControl&quot;</span>); <br><span class="hljs-comment">// 获取设备管理服务</span><br><br>deviceMan.RegistCardCallback(<br>  <span class="hljs-keyword">new</span> Action&lt;<span class="hljs-built_in">dynamic</span>&gt;(<br>    (<span class="hljs-built_in">dynamic</span> data) =&gt; <span class="hljs-comment">// 含有一个 dynamic 类型的参数 data</span><br>    &#123;<br>      <span class="hljs-built_in">string</span> cardid = data.OperaDeviceData.Message;<br>      <span class="hljs-comment">// 获取 data 的属性</span><br>      DoSomething(cardid);<br>    &#125;<br>  ) <br>  <span class="hljs-comment">// 创建一个 Action&lt;dynamic&gt; 实例，用一个委托（delegate）实例化</span><br>  <span class="hljs-comment">// 这个 Action&lt;dynamic&gt; 中的内容将会在刷卡时时被执行</span><br>); <span class="hljs-comment">// 调用 RegistCardCallback 方法</span><br></code></pre></td></tr></table></figure><h1 id="二、通软插件的反编译修改"><a href="#二、通软插件的反编译修改" class="headerlink" title="二、通软插件的反编译修改"></a>二、通软插件的反编译修改</h1><h2 id="0-概论-1"><a href="#0-概论-1" class="headerlink" title="0. 概论"></a>0. 概论</h2><p>尽管服务可以解决相当一部分的问题。但是仍然有一部分功能并没有被写在服务中，无法通过简单的方法进行调用，这时候就需要对通软原有的插件进行反编译修改。</p><h2 id="1-基本流程案例"><a href="#1-基本流程案例" class="headerlink" title="1. 基本流程案例"></a>1. 基本流程案例</h2><p>这里以播放跑马灯进行举例说明。</p><p>众所周知，通软在 <code>GS.Terminal.SmartBoard.Logic</code> 中给出了跑马灯的实现（<code>GS.Terminal.SmartBoard.Logic.Garitures.BannerMessageControl</code>）。但是，播放跑马灯的方法，并不能通过某个服务进行调用。因此，有必要通过某种的举措，将播放跑马灯的方法暴露给其他插件。</p><p>考虑以下操作：</p><ol><li>使用 dnSpy 在 <code>GS.Terminal.SmartBoard.Logic.Core</code> 下创建一个 <code>MyCustomService</code> 类。</li><li>修改 <code>GS.Terminal.SmartBoard.Logic</code> 的 <code>Mapper.xml</code>，注册这个类为一个服务。</li><li>在这个类中添加以下代码：</li></ol><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">using</span> GS.Terminal.SmartBoard.Logic.Garitures;<br>...<br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title">GS.Terminal.SmartBoard.Logic.Core</span><br>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">MyCustomService</span><br>    &#123;<br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ShowShadowLantern</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> msg</span>)</span><br>        &#123;<br>            BannerMessageControl.AddBannerMsg(msg);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ol start="4"><li>编译并保存。</li></ol><p>然后，就可以在其他插件中通过服务调用 <code>MyCustomService.ShowShadowLantern()</code> 显示跑马灯了。</p><h2 id="2-特殊功能备忘：滑动页面相关"><a href="#2-特殊功能备忘：滑动页面相关" class="headerlink" title="2. 特殊功能备忘：滑动页面相关"></a>2. 特殊功能备忘：滑动页面相关</h2><p>电子班牌的滑动页面是一个非常有趣的东西。比如“班级风采”<br>一栏，又可以放图片又可以放视频，可以说有很多手脚可以动。</p><p>但是，令人意外的是，不像跑马灯和“更多”栏里面的大图片，“班级风采”里面图片视频等的定时展示并非使用 <code>TimeLineTask</code>，而是另一套非常复杂（且非常屎山）的实现。</p><p>这种实现方式可以归纳为 <code>VisualPublish - VisualTemplate - VisualBlock</code> 的三级结构（具体实现时还包含了大量的数据库读写）。其中：</p><ul><li><code>VisualPublish</code> 规定了电子班牌加载时使用的主题。</li><li><code>VisualTemplate</code> 描述滑动界面的结构及属性。</li><li><code>VisualBlock</code> 描述滑动页面上的元素的结构及属性。</li></ul><p>如果想要修改“班级风采”上的视频，考虑以下实现：</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">using</span> System;<br><span class="hljs-keyword">using</span> System.Collections.Generic;<br><span class="hljs-keyword">using</span> System.Drawing;<br><span class="hljs-keyword">using</span> System.IO;<br><span class="hljs-keyword">using</span> GalaSoft.MvvmLight.Threading;<br><span class="hljs-keyword">using</span> IVisualBlock;<br><span class="hljs-keyword">using</span> SmartBoardViewModels.Models.VisualBlock;<br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title">GS.Terminal.SmartBoard.Logic.Core</span><br>&#123;<br>    <span class="hljs-comment">// Token: 0x02000174 RID: 372</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">partial</span> <span class="hljs-keyword">class</span> <span class="hljs-title">MyCustomService</span><br>    &#123;<br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">AddMultiMediaVisualTemplate</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> media_json_filename</span>)</span><br>        &#123;<br>            IBlockService firstOrDefaultService = Program.AddonContext.GetFirstOrDefaultService&lt;IBlockService&gt;(<span class="hljs-string">&quot;GS.Terminal.VisualBlock&quot;</span>);<br>            <span class="hljs-comment">// 获取 VisualBlock 有关服务</span><br><br>            BlockTemplate blockTemplate = <span class="hljs-keyword">new</span> BlockTemplate();<br>            blockTemplate.TemplateName = <span class="hljs-string">&quot;ClassTemplateStyle&quot;</span>;<br>            blockTemplate.DisplayName = <span class="hljs-string">&quot;校园风采&quot;</span>;<br>            blockTemplate.Index = <span class="hljs-number">2</span>;<br>            blockTemplate.TemplateType = BlockTemplateType.Theme;<br>      <span class="hljs-comment">// 创建“班级风采” BlockTemplate，和 localData.db 中属性完全对应</span><br><br>            BaseBlock block = firstOrDefaultService.GetBlock(<span class="hljs-string">&quot;ClassMultiMedia&quot;</span>);<br>            block.Init(Program.AddonContext);<br>      <span class="hljs-comment">// 获取视频与图片控件的 VisualBlock 并初始化</span><br>      <span class="hljs-comment">// 位于 GS.Terminal.VisualBlock/Bundles/VisualBlock.dll</span><br><br>            IUpdate update = (IUpdate)block;<br>            update.LoadLocalData(media_json_filename);<br>      <span class="hljs-comment">// 加载指定 json 文件中的数据</span><br>      <span class="hljs-comment">// 具体的 json 文件结构可以通过抓包或者模仿 cache/BlockCache/&lt;((IBlock)block).TypeName&gt;_&lt;GUID&gt;.json查看</span><br><br>      <span class="hljs-comment">// 这里必须强制类型转换为 IUpdate 类型，因为 VisualBlock 的该方法继承自 IUpdate 接口</span><br><br>            blockTemplate.Blocks = <span class="hljs-keyword">new</span> List&lt;VisualBlockItem&gt;();<br>            blockTemplate.Blocks.Add(<span class="hljs-keyword">new</span> VisualBlockItem<br>            &#123;<br>                Id = Guid.NewGuid(),<br>                BlockComponent = <span class="hljs-string">&quot;班级风采&quot;</span>,<br>                BlockTypeName = ((IBlock)block).TypeName,<br>                DataSource = <span class="hljs-string">&quot;Services/SmartBoard/BlockClassMultiMedia/json&quot;</span>,<br>                Height = <span class="hljs-number">10</span>,<br>                NavTemplateName = <span class="hljs-string">&quot;&quot;</span>,<br>                Width = <span class="hljs-number">20</span>,<br>                X = <span class="hljs-number">1</span>,<br>                Y = <span class="hljs-number">1</span>,<br>        <span class="hljs-comment">// 某些时候，还有一个 int Template 属性</span><br>        <span class="hljs-comment">// 上方属性均与 localData.db 中一致</span><br>                DataContext = (BaseBlock)update<br>        <span class="hljs-comment">// 再进行一次强制类型转换</span><br>            &#125;);<br><br>            blockTemplate.Previous = Utilites.ViewModelLocator.MainPage.TemplateList[<span class="hljs-number">1</span>];<br>            blockTemplate.Next = Utilites.ViewModelLocator.MainPage.TemplateList[<span class="hljs-number">3</span>];<br>      <span class="hljs-comment">// 链表实现</span><br><br>            DispatcherHelper.RunAsync(<span class="hljs-built_in">delegate</span><br>            &#123;<br>        <span class="hljs-comment">// DispatcherHelper 为 Mvvm 的内容</span><br>        <span class="hljs-comment">// (GS.Terminal.SmartBoard.Logic.Core.)Utilites 为 GS 的杂项工具</span><br>                Utilites.ViewModelLocator.MainPage.TemplateList[<span class="hljs-number">2</span>] = blockTemplate;<br>                <span class="hljs-comment">// 替换</span><br>            &#125;);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>事实上，同样的操作也适用于其他滑动页面，只要把各种属性的值替换掉就行了。<br>当然，有的页面上可能有多个 <code>VisualBlock</code>（如首页）。</p><h1 id="三、杂项"><a href="#三、杂项" class="headerlink" title="三、杂项"></a>三、杂项</h1><h2 id="1-插件签名认证"><a href="#1-插件签名认证" class="headerlink" title="1. 插件签名认证"></a>1. 插件签名认证</h2><p>前面提到，<code>Mapper.xml</code> 中的 <code>License</code> 字段必须正确配置，否则插件无法启动。根据通软的描述，所谓的插件证书只能在“通软统一开发平台”获取，但实际上并不存在这样的一个平台。对此，只能说傻逼通软。</p><p>因此，如果想要加载我们自己的插件，必须想办法解决掉这个证书的问题。解决思路可以有以下两种：</p><ol><li>伪造证书；</li><li>绕过证书检测</li></ol><p>以下，将分别介绍这两种思路。</p><h3 id="a-伪造证书"><a href="#a-伪造证书" class="headerlink" title="a. 伪造证书"></a>a. 伪造证书</h3><p>通软的证书表面上使用了一个所谓加密狗（<code>SoftDog</code>）组件，实际上只是绕了一个弯从加密狗的 dll 文件的资源文件中获取 RSA 私钥。而通软所谓的认证，也不过只是用这个私钥对插件名称进行了一个签名而已。</p><p>因此，只要提取加密狗的资源文件，便可以利用 RSA 签名轻松伪造通软的认证。</p><p>考虑以下代码：</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">using</span> System;<br><span class="hljs-keyword">using</span> System.Security.Cryptography;<br>...<br><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> <span class="hljs-title">Encrypt</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> addonSymbolicName</span>)</span><br>        &#123;<br>            <span class="hljs-keyword">using</span> (RSACryptoServiceProvider provider = <span class="hljs-keyword">new</span> RSACryptoServiceProvider())<br>            &#123;<br>                <span class="hljs-built_in">string</span> xmlStr = <span class="hljs-string">&quot;...&quot;</span>;<br>                provider.FromXmlString(xmlStr);<br>                RSAPKCS1SignatureFormatter formatter = <span class="hljs-keyword">new</span> RSAPKCS1SignatureFormatter(provider);<br>                formatter.SetHashAlgorithm(<span class="hljs-string">&quot;SHA1&quot;</span>);<br><br>                SHA1Managed sha1 = <span class="hljs-keyword">new</span> SHA1Managed();<br>                <span class="hljs-built_in">byte</span>[] rgbHash = sha1.ComputeHash(Encoding.ASCII.GetBytes(addonSymbolicName));<br><br>                <span class="hljs-built_in">byte</span>[] signature = formatter.CreateSignature(rgbHash);<br>                <span class="hljs-built_in">string</span> b64str = Convert.ToBase64String(signature);<br><br>                <span class="hljs-keyword">return</span> b64str;<br>            &#125;<br>        &#125;<br></code></pre></td></tr></table></figure><p>这样，只要输入一个插件的 <code>AddonSymbolicName</code>，便可以生成对应的认证。</p><h3 id="b-绕过检测"><a href="#b-绕过检测" class="headerlink" title="b. 绕过检测"></a>b. 绕过检测</h3><p>通过对 <code>GS.Unitive.Framework.Core.</code><strong><code>LicenseValidation</code></strong> 的 <code>Verify()</code> 方法进行修改，使其返回值恒为真，以绕过通软的插件认证检测。</p><p>这个方法由于过于暴力，并且已经有更加安全的平替，不建议使用。</p><h2 id="2-关于-localData-db"><a href="#2-关于-localData-db" class="headerlink" title="2. 关于 localData.db"></a>2. 关于 <code>localData.db</code></h2><p>建议使用 <code>SQLiteStudio</code> 打开，格式 <code>System.Data</code>，密码一般为 <code>123</code>。</p><h2 id="3-更新器无效化"><a href="#3-更新器无效化" class="headerlink" title="3. 更新器无效化"></a>3. 更新器无效化</h2><p>为了防止更新导致反编译修改的代码被覆盖，有必要对更新器 <code>AutoUpdate.exe</code> 进行无效化处理。</p><p>主要处理 <code>AutoUpdate.MainViewModel</code> 的 <code>Do()</code> 方法。</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Do</span>()</span><br>&#123;<br>  ...<br>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.getRemoteFeatureCode(text))<br>    &#123;<br>        LocalLogWriter.Write(<span class="hljs-string">&quot;无更新&quot;</span>);<br>    &#125;<br>  ...<br>&#125;<br></code></pre></td></tr></table></figure><p>这样一来，即使有更新，也不会下载更新。</p><h2 id="4-关于编译器生成代码的反推"><a href="#4-关于编译器生成代码的反推" class="headerlink" title="4. 关于编译器生成代码的反推"></a>4. 关于编译器生成代码的反推</h2><p>注意到通软的一些插件反编译后仍然存在大量无法进一步还原的编译器生成代码，阅读起来非常困难。以下介绍一点简单的识别法。</p><h3 id="a-执行动态类型方法"><a href="#a-执行动态类型方法" class="headerlink" title="a. 执行动态类型方法"></a>a. 执行动态类型方法</h3><p>考虑以下代码：</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-comment">// GS.Terminal.SmartBoard.Logic.Core.Startup</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Startup</span><br>&#123;<br>  ...<br>  <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">InitManagentWindow</span>() <span class="hljs-comment">// 通软传统艺能之拼写错误</span></span><br>  &#123;<br>    <span class="hljs-keyword">if</span> (Startup.&lt;&gt;o__6.&lt;&gt;p__0 == <span class="hljs-literal">null</span>)<br>        &#123;<br>          Startup.&lt;&gt;o__6.&lt;&gt;p__0 = CallSite&lt;Action&lt;CallSite, <span class="hljs-built_in">object</span>, <span class="hljs-built_in">string</span>, Action&gt;&gt;.Create(Binder.InvokeMember(CSharpBinderFlags.ResultDiscarded, <span class="hljs-string">&quot;RegistBackgroundCommand&quot;</span>, <span class="hljs-comment">//方法名称在这里</span><br>          <span class="hljs-literal">null</span>, <span class="hljs-keyword">typeof</span>(Startup), <span class="hljs-keyword">new</span> CSharpArgumentInfo[]<br>          &#123;<br>            CSharpArgumentInfo.Create(CSharpArgumentInfoFlags.None, <span class="hljs-literal">null</span>),<br>            CSharpArgumentInfo.Create(CSharpArgumentInfoFlags.UseCompileTimeType | CSharpArgumentInfoFlags.Constant, <span class="hljs-literal">null</span>),<br>            CSharpArgumentInfo.Create(CSharpArgumentInfoFlags.UseCompileTimeType, <span class="hljs-literal">null</span>)<br>          &#125;));<br>        &#125;<br>        Startup.&lt;&gt;o__6.&lt;&gt;p__0.Target(Startup.&lt;&gt;o__6.&lt;&gt;p__0, Program.AddonContext.GetFirstOrDefaultService(<span class="hljs-string">&quot;GS.Terminal.MainShell&quot;</span>, <span class="hljs-string">&quot;GS.Terminal.MainShell.Services.UIService&quot;</span>), <span class="hljs-comment">// 包含相应方法的 dynamic 类型。在这里是 GetFirstOrDefaultService() 的返回值</span><br>        <span class="hljs-string">&quot;100000&quot;</span>, <span class="hljs-comment">// 参数 1</span><br>        <span class="hljs-built_in">delegate</span><br>        &#123;<br>          DoSomething();<br>        &#125; <span class="hljs-comment">// 参数 2，当然自己写的时候应当在 delegate 外面套一个 Action()</span><br>        <span class="hljs-comment">// 以上两个参数与 GS.Terminal.MainShell.Services.UIService.GetFirstOrDefaultService(string, Action) 一一对应。</span><br>      );<br>  &#125;<br>  ...<br>&#125;<br></code></pre></td></tr></table></figure><p>因此，原始代码应当为：</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Startup</span><br>&#123;<br>  ...<br>  <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">InitManagentWindow</span>() <span class="hljs-comment">// 通软传统艺能之拼写错误</span></span><br>  &#123;<br>    <span class="hljs-built_in">dynamic</span> service = Program.AddonContext.GetFirstOrDefaultService(<span class="hljs-string">&quot;GS.Terminal.MainShell&quot;</span>, <span class="hljs-string">&quot;GS.Terminal.MainShell.Services.UIService&quot;</span>);<br>    service.RegistBackgroundCommand(<span class="hljs-string">&quot;100000&quot;</span>, <span class="hljs-keyword">new</span> Action(<br>      () =&gt; &#123;<br>        DoSomething();<br>      &#125;<br>    ));<br>  &#125;<br>  ...<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="b-获取动态类型的属性"><a href="#b-获取动态类型的属性" class="headerlink" title="b. 获取动态类型的属性"></a>b. 获取动态类型的属性</h3><p>这个在刷卡器反编译出的代码处表现的尤其明显。考虑以下代码：</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-comment">// GS.Terminal.SmartBoard.Logic.Core.LogicCore</span><br><span class="hljs-keyword">internal</span> <span class="hljs-keyword">class</span> <span class="hljs-title">LogicCore</span><br>&#123;<br>  ...<br>  <span class="hljs-function"><span class="hljs-keyword">internal</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">RegistCardService</span>()</span><br>  &#123;<br>    <span class="hljs-built_in">object</span> firstOrDefaultService = Program.AddonContext.GetFirstOrDefaultService(<span class="hljs-string">&quot;GS.Terminal.DeviceManager&quot;</span>, <span class="hljs-string">&quot;GS.Terminal.DeviceManager.Service.DeviceCallControl&quot;</span>);<br>    <span class="hljs-comment">// 获取了 DeviceCallControl -&gt; dynamic，部分内部实现细节被反编译器隐藏</span><br>    ...<br>    <span class="hljs-keyword">if</span> (target(&lt;&gt;p__, LogicCore.&lt;&gt;o__1.&lt;&gt;p__0.Target(LogicCore.&lt;&gt;o__1.&lt;&gt;p__0, firstOrDefaultService, <span class="hljs-literal">null</span>)))<br>        &#123; <br>        <span class="hljs-comment">// 这里似乎是一个判断获取的服务是否是 null</span><br>                <span class="hljs-keyword">if</span> (LogicCore.&lt;&gt;o__1.&lt;&gt;p__5 == <span class="hljs-literal">null</span>)<br>                &#123;<br>                    LogicCore.&lt;&gt;o__1.&lt;&gt;p__5 = CallSite&lt;Action&lt;CallSite, <span class="hljs-built_in">object</span>, Action&lt;<span class="hljs-built_in">object</span>&gt;&gt;&gt;.Create(Binder.InvokeMember(CSharpBinderFlags.ResultDiscarded, <span class="hljs-string">&quot;RegistCardCallback&quot;</span>, <span class="hljs-literal">null</span>, <span class="hljs-keyword">typeof</span>(LogicCore), <span class="hljs-keyword">new</span> CSharpArgumentInfo[]<br>                    &#123;<br>                        CSharpArgumentInfo.Create(CSharpArgumentInfoFlags.None, <span class="hljs-literal">null</span>),<br>                        CSharpArgumentInfo.Create(CSharpArgumentInfoFlags.UseCompileTimeType, <span class="hljs-literal">null</span>)<br>                    &#125;));<br>          <span class="hljs-comment">// 执行 DeviceCallControl.RegistCardCallback(Action&lt;dynamic&gt;) 方法</span><br>                &#125;<br>                LogicCore.&lt;&gt;o__1.&lt;&gt;p__5.Target(LogicCore.&lt;&gt;o__1.&lt;&gt;p__5, firstOrDefaultService,<br><br>        <span class="hljs-comment">//注意，从这里开始是参数 1 即 Action&lt;dynamic&gt;！</span><br>        <span class="hljs-built_in">delegate</span>(<span class="hljs-built_in">dynamic</span> data)<br>                &#123;<br>                    LogicCore.&lt;&gt;c__DisplayClass1_0 CS$&lt;&gt;<span class="hljs-number">8</span>__locals1 = <span class="hljs-keyword">new</span> LogicCore.&lt;&gt;c__DisplayClass1_0();<br>                    LogicCore.&lt;&gt;c__DisplayClass1_0 CS$&lt;&gt;<span class="hljs-number">8</span>__locals2 = CS$&lt;&gt;<span class="hljs-number">8</span>__locals1;<br>          <span class="hljs-comment">// 创建了一个 LogicCore.&lt;&gt;c__DisplayClass1_0 的实例。</span><br>          <span class="hljs-comment">// 在源代码里，这个类应该有别的名字，并且和 LogicCore 在同一个 .cs 文件里</span><br>          <span class="hljs-comment">// 根据后面的代码发现，它至少有一个 cardNum 属性</span><br><br>                    <span class="hljs-keyword">if</span> (LogicCore.&lt;&gt;o__1.&lt;&gt;p__4 == <span class="hljs-literal">null</span>)<br>                    &#123;<br>                        LogicCore.&lt;&gt;o__1.&lt;&gt;p__4 = CallSite&lt;Func&lt;CallSite, <span class="hljs-built_in">object</span>, <span class="hljs-built_in">string</span>&gt;&gt;.Create(Binder.Convert(CSharpBinderFlags.None, <span class="hljs-keyword">typeof</span>(<span class="hljs-built_in">string</span>), <span class="hljs-keyword">typeof</span>(LogicCore)));<br>                    &#125;<br>                    Func&lt;CallSite, <span class="hljs-built_in">object</span>, <span class="hljs-built_in">string</span>&gt; target2 = LogicCore.&lt;&gt;o__1.&lt;&gt;p__4.Target;<br>                    CallSite &lt;&gt;p__2 = LogicCore.&lt;&gt;o__1.&lt;&gt;p__4;<br>          <span class="hljs-comment">// 作用未知</span><br><br>                    <span class="hljs-keyword">if</span> (LogicCore.&lt;&gt;o__1.&lt;&gt;p__3 == <span class="hljs-literal">null</span>)<br>                    &#123;<br>                        LogicCore.&lt;&gt;o__1.&lt;&gt;p__3 = CallSite&lt;Func&lt;CallSite, <span class="hljs-built_in">object</span>, <span class="hljs-built_in">object</span>&gt;&gt;.Create(Binder.GetMember(CSharpBinderFlags.None, <span class="hljs-string">&quot;Message&quot;</span>, <span class="hljs-keyword">typeof</span>(LogicCore), <span class="hljs-keyword">new</span> CSharpArgumentInfo[]<br>                        &#123;<br>                            CSharpArgumentInfo.Create(CSharpArgumentInfoFlags.None, <span class="hljs-literal">null</span>)<br>                        &#125;));<br>                    &#125;<br>                    Func&lt;CallSite, <span class="hljs-built_in">object</span>, <span class="hljs-built_in">object</span>&gt; target3 = LogicCore.&lt;&gt;o__1.&lt;&gt;p__3.Target;<br>                    CallSite &lt;&gt;p__3 = LogicCore.&lt;&gt;o__1.&lt;&gt;p__3;<br>          <span class="hljs-comment">// 后获得 data.OperaDeviceData.Message 属性</span><br><br>                    <span class="hljs-keyword">if</span> (LogicCore.&lt;&gt;o__1.&lt;&gt;p__2 == <span class="hljs-literal">null</span>)<br>                    &#123;<br>                        LogicCore.&lt;&gt;o__1.&lt;&gt;p__2 = CallSite&lt;Func&lt;CallSite, <span class="hljs-built_in">object</span>, <span class="hljs-built_in">object</span>&gt;&gt;.Create(Binder.GetMember(CSharpBinderFlags.None, <span class="hljs-string">&quot;OperaDeviceData&quot;</span>, <span class="hljs-keyword">typeof</span>(LogicCore), <span class="hljs-keyword">new</span> CSharpArgumentInfo[]<br>                        &#123;<br>                            CSharpArgumentInfo.Create(CSharpArgumentInfoFlags.None, <span class="hljs-literal">null</span>)<br>                        &#125;));<br>                    &#125;<br>          <span class="hljs-comment">// 先获得 data.OperaDeviceData 属性</span><br><br>          <span class="hljs-comment">// 注意！属性级别越靠前，它在编译器生成代码中的位置就越靠后！</span><br>          <span class="hljs-comment">// 具体细节仍然有必要查看源代码</span><br><br>          <span class="hljs-comment">// 例如在 GS.Terminal.DeviceManager.Service.DeviceCallControl 里，</span><br>          <span class="hljs-comment">// RegistCardCallback(Action&lt;dynamic&gt;) 方法实际上是用这个 Action&lt;dynamic&gt;</span><br>          <span class="hljs-comment">// 创建了一个事件处理器，其 EventArgs 为 DeviceEventArgs，</span><br>          <span class="hljs-comment">// DeviceEventArgs 即包含 OperaDeviceData 属性，</span><br>          <span class="hljs-comment">// OperaDeviceData 又有 Message 属性</span><br><br>                    CS$&lt;&gt;<span class="hljs-number">8</span>__locals2.cardNum = target2(&lt;&gt;p__2, target3(&lt;&gt;p__3, LogicCore.&lt;&gt;o__1.&lt;&gt;p__2.Target(LogicCore.&lt;&gt;o__1.&lt;&gt;p__2, data)));<br>          <span class="hljs-comment">// 将 data.OperaDeviceData 赋给 CS$&lt;&gt;8__locals2.cardNum</span><br><br>                    Program.AddonContext.Logger.Debug(<span class="hljs-string">&quot;读卡器读卡结果：&quot;</span> + CS$&lt;&gt;<span class="hljs-number">8</span>__locals1.cardNum, <span class="hljs-literal">null</span>);<br>      &#125;<br>      <span class="hljs-comment">// 到这里参数 1 结束！</span><br>      );<br>    &#125;<br>  &#125;<br>  ...<br>&#125;<br></code></pre></td></tr></table></figure><p>由此，可以得出，原始代码可能为：</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-built_in">dynamic</span> service = Program.AddonContext.GetFirstOrDefaultService(<span class="hljs-string">&quot;GS.Terminal.DeviceManager&quot;</span>, <span class="hljs-string">&quot;GS.Terminal.DeviceManager.Service.DeviceCallControl&quot;</span>);<br><span class="hljs-keyword">if</span> (service != <span class="hljs-literal">null</span>)<br>&#123;<br>  service.RegistCardCallback(<span class="hljs-keyword">new</span> Action&lt;<span class="hljs-built_in">dynamic</span>&gt;(<br>    (<span class="hljs-built_in">dynamic</span> data) =&gt; &#123;<br>      SomeClass someclass = <span class="hljs-keyword">new</span> SomeClass();<br>      someclass.cardNum = data.OperaDeviceData.Message;<br><br>      Program.AddonContext.Logger.Debug(...);<br>    &#125;<br>  ));<br>&#125;<br></code></pre></td></tr></table></figure><p>以上。</p>]]></content>
    
    
    
    <tags>
      
      <tag>破解</tag>
      
      <tag>通软系列软件</tag>
      
      <tag>.Net</tag>
      
      <tag>C#</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>【旧文】通软电子班牌 GarnitureControl 与 VisualBlock 原理详解</title>
    <link href="/2025/12/05/%E3%80%90%E6%97%A7%E6%96%87%E3%80%91%E9%80%9A%E8%BD%AF%E7%94%B5%E5%AD%90%E7%8F%AD%E7%89%8C-GarnitureControl-%E4%B8%8E-VisualBlock-%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3/"/>
    <url>/2025/12/05/%E3%80%90%E6%97%A7%E6%96%87%E3%80%91%E9%80%9A%E8%BD%AF%E7%94%B5%E5%AD%90%E7%8F%AD%E7%89%8C-GarnitureControl-%E4%B8%8E-VisualBlock-%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3/</url>
    
    <content type="html"><![CDATA[<blockquote><p>高中时候写的文章，现在搬过来。</p></blockquote><h2 id="一、关于-GarnitureControl"><a href="#一、关于-GarnitureControl" class="headerlink" title="一、关于 GarnitureControl"></a>一、关于 GarnitureControl</h2><h3 id="1-GarnitureControl-的加载与获取"><a href="#1-GarnitureControl-的加载与获取" class="headerlink" title="1. GarnitureControl 的加载与获取"></a>1. GarnitureControl 的加载与获取</h3><p>查看 <code>GS.Terminal.GarnitureControl.ControlFinder</code>，注意到</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ControlFinder</span> : <span class="hljs-title">IDisposable</span><br>&#123;<br>    [<span class="hljs-meta">ImportMany(typeof(IControl))</span>]<br>    <span class="hljs-keyword">public</span> IControl[] Views;<br>    <span class="hljs-comment">// Token: 0x06000005 RID: 5 RVA: 0x000020DC File Offset: 0x000002DC</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">bool</span> <span class="hljs-title">Find</span>()</span><br>    &#123;<br>        <span class="hljs-keyword">try</span><br>        &#123;<br>            AggregateCatalog aggregateCatalog = <span class="hljs-keyword">new</span> AggregateCatalog();<br>            DirectoryCatalog item = <span class="hljs-keyword">new</span> DirectoryCatalog(AddonActivator.AddonContext.Addon.Location + <span class="hljs-string">&quot;\\Controls&quot;</span>, <span class="hljs-string">&quot;*.dll&quot;</span>);<br>            aggregateCatalog.Catalogs.Add(item);<br>            <span class="hljs-keyword">new</span> CompositionContainer(aggregateCatalog, <span class="hljs-keyword">new</span> ExportProvider[<span class="hljs-number">0</span>]).ComposeParts(<span class="hljs-keyword">new</span> <span class="hljs-built_in">object</span>[]<br>            &#123;<br>                <span class="hljs-keyword">this</span><br>            &#125;);<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125;<br>        <span class="hljs-keyword">catch</span> (Exception errorException)<br>        &#123;<br>            AddonActivator.AddonContext.Logger.Error(<span class="hljs-string">&quot;查找Control出错&quot;</span>, errorException);<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>基本操作，没什么好说的，使用 <code>System.ComponentModel.Composition</code> 反射动态地加载程序集中指定类型（实现了 <code>IControl</code> 接口）的类罢了。</p><p>看到服务类。注意，这一段比较重要！虽然说只是获取一个 <code>GarnitureControl</code> 对象，但是涉及到一个 <code>Action</code>，其他地方可能用到。</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">namespace</span> <span class="hljs-title">GS.Terminal.GarnitureControl</span><br>&#123;<br>    <span class="hljs-comment">// Token: 0x02000005 RID: 5</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Service</span><br>    &#123;<br>        <span class="hljs-comment">// Token: 0x06000012 RID: 18 RVA: 0x0000225C File Offset: 0x0000045C</span><br><br>        <span class="hljs-comment">// 两个参数。一个键，另一个是返回的 Action</span><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> UserControl <span class="hljs-title">FindControlByKey</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> key, <span class="hljs-keyword">ref</span> Action&lt;<span class="hljs-built_in">object</span>&gt; handle</span>)</span><br>        &#123;<br>            GarnitureControl garnitureControl = GarnitureControl.Controls.FirstOrDefault((GarnitureControl ss) =&gt; ss.ControlKey == key);<br>            <span class="hljs-comment">// 根据名称获取</span><br>            <span class="hljs-keyword">if</span> (garnitureControl == <span class="hljs-literal">null</span>)<br>            &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>            &#125;<br>            UserControl controlEntity = garnitureControl.ControlEntity;<br>            IControl @object = (IControl)controlEntity; <br>            <span class="hljs-comment">// 强制类型转换为 IControl。因为 @object.setData() 方法实现自 IControl.setData()</span><br>            handle = <span class="hljs-keyword">new</span> Action&lt;<span class="hljs-built_in">object</span>&gt;(@object.setData);<br>            <span class="hljs-comment">// 这样，在别处就可以通过 handle(args) 调用 @object.setData() 了</span><br>            <span class="hljs-keyword">return</span> controlEntity;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="2-GarnitureControl-的有关操作"><a href="#2-GarnitureControl-的有关操作" class="headerlink" title="2. GarnitureControl 的有关操作"></a>2. GarnitureControl 的有关操作</h3><p>关于如何添加 <code>GarnitureControl</code> 不是这里讨论的重点。这里主要介绍如何操纵已经存在的 <code>GarnitureControl</code>。</p><p>以跑马灯为例。看到 <code>/GS.Terminal.GarnitureControl/Controls/CommonControls.dll - CommonControls.BannerMessage</code>。我们主要关心它的 <code>setData()</code> 方法。</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs csharp">[<span class="hljs-meta">ControlInfo(<span class="hljs-string">&quot;跑马灯信息展示&quot;</span>, <span class="hljs-string">&quot;BannerMessage&quot;</span>)</span>]<br><span class="hljs-comment">// ControlInfo 属性中 BannerMessage 就是 FindControlByKey() 的参数 key</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">BannerMessage</span> : <span class="hljs-title">UserControl</span>, <span class="hljs-title">IControl</span>, <span class="hljs-title">IComponentConnector</span><br>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setData</span>(<span class="hljs-params"><span class="hljs-built_in">object</span> data</span>)</span><br>    &#123;<br>        <span class="hljs-built_in">bool</span> flag = data != <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">if</span> (flag)<br>        &#123;<br>            <span class="hljs-built_in">bool</span> flag2 = data.ToString().StartsWith(<span class="hljs-string">&quot;Command.Add&quot;</span>);<br>            <span class="hljs-comment">// 如果发送的 data 以 Command.Add 开头……</span><br>            <span class="hljs-keyword">if</span> (flag2)<br>            &#123;<br>                <span class="hljs-keyword">this</span>.MsgList.Add(data.ToString().Substring(<span class="hljs-number">11</span>));<br>                <span class="hljs-comment">// ……则添加 Command.Add 后面的文本到跑马灯列表</span><br>            &#125;<br>            <span class="hljs-built_in">bool</span> flag3 = data.ToString().StartsWith(<span class="hljs-string">&quot;Command.Remove&quot;</span>);<br>            <span class="hljs-comment">// 同理</span><br>            <span class="hljs-keyword">if</span> (flag3)<br>            &#123;<br>                <span class="hljs-keyword">this</span>.MsgList.Remove(data.ToString().Substring(<span class="hljs-number">14</span>));<br>            &#125;<br>            <span class="hljs-built_in">bool</span> flag4 = <span class="hljs-keyword">this</span>.MsgList.Count == <span class="hljs-number">1</span>;<br>            <span class="hljs-comment">// 如果有跑马灯列表里有文本……</span><br>            <span class="hljs-keyword">if</span> (flag4)<br>            &#123;<br>                <span class="hljs-comment">// ……则播放</span><br>                <span class="hljs-keyword">this</span>.canvas1.Visibility = Visibility.Visible;<br>                <span class="hljs-keyword">this</span>.PlayIndex = <span class="hljs-number">0</span>;<br>                <span class="hljs-keyword">this</span>.CeaterAnimation(<span class="hljs-keyword">this</span>.msg);<br>            &#125;<br>            <span class="hljs-built_in">bool</span> flag5 = <span class="hljs-keyword">this</span>.MsgList.Count == <span class="hljs-number">0</span>;<br>            <span class="hljs-keyword">if</span> (flag5)<br>            &#123;<br>                <span class="hljs-comment">// ……否则隐藏跑马灯组件</span><br>                <span class="hljs-keyword">this</span>.canvas1.Visibility = Visibility.Collapsed;<br>                <span class="hljs-keyword">this</span>.msg.Text = <span class="hljs-string">&quot;&quot;</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>再看看 <code>GS.Terminal.SmartBoard.Logic.Garitures</code> 中如何初始化 <code>BannerMessage</code>？</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-function"><span class="hljs-keyword">internal</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">InitBannerMessageControl</span>()</span><br>&#123;<br>    <span class="hljs-built_in">double</span> width;<br>    <span class="hljs-built_in">double</span> left;<br>    <span class="hljs-built_in">double</span> top;<br>    <span class="hljs-keyword">if</span> (SystemParameters.PrimaryScreenWidth == <span class="hljs-number">1080.0</span>)<br>    &#123;<br>        width = <span class="hljs-number">1020.0</span>;<br>        left = <span class="hljs-number">30.0</span>;<br>        top = <span class="hljs-number">1598.0</span>;<br>    &#125;<br>    <span class="hljs-keyword">else</span><br>    &#123;<br>        width = <span class="hljs-number">1700.0</span>;<br>        left = <span class="hljs-number">110.0</span>;<br>        top = <span class="hljs-number">840.0</span>;<br>    &#125;<br>    <span class="hljs-comment">// 设置位置，无需多言</span><br>    GarnitureControl garnitureControl = <span class="hljs-keyword">new</span> GarnitureControl();<br>    Action&lt;<span class="hljs-built_in">object</span>&gt; controlHandle = <span class="hljs-literal">null</span>;<br>    <span class="hljs-comment">// 实例化</span><br>    UserControl userControl = Utilites.FindControlByKey(<span class="hljs-string">&quot;BannerMessage&quot;</span>, <span class="hljs-keyword">ref</span> controlHandle);<br>    <span class="hljs-comment">// 通过 Utilities 中对 GS.Terminal.GarnitureControl.Service.FindControlByKey() 方法的封装，查询名为 BannerMessage 的 GarnitureControl</span><br>    garnitureControl.ControlHandle = controlHandle;<br>    <span class="hljs-comment">// 设置其 ControlHandle，相当于 setData()</span><br>    userControl.Width = width;<br>    garnitureControl.ControlEntity = userControl;<br>    garnitureControl.ID = Utilites.AddGarnitureControl(userControl, top, left);<br>    <span class="hljs-comment">// 添加</span><br>    garnitureControl.Key = <span class="hljs-string">&quot;BannerMessage&quot;</span>;<br>    GaritureCore.GarnitureControlList.Add(garnitureControl);<br>    Program.TerminalStateManagement.StateChanged += BannerMessageControl.TerminalStateManagement_StateChanged;<br>&#125;<br></code></pre></td></tr></table></figure><p>这时候，看到 <code>GS.Terminal.SmartBoard.Logic.Garitures.BannerMessageControl</code>，它实际上是对 <code>CommonControls.BannerMessage.setData()</code> 的一系列封装。</p><p>以添加跑马灯消息为例。</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-function"><span class="hljs-keyword">internal</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">AddBannerMsg</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> Msg</span>)</span><br>&#123;<br>    <span class="hljs-keyword">if</span> (BannerMessageControl.banner == <span class="hljs-literal">null</span>)<br>    &#123;<br>        BannerMessageControl.banner = GaritureCore.GarnitureControlList.FirstOrDefault((GarnitureControl ss) =&gt; ss.Key == <span class="hljs-string">&quot;BannerMessage&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (BannerMessageControl.banner != <span class="hljs-literal">null</span>)<br>    &#123;<br>        Program.AddonContext.Logger.Debug(<span class="hljs-string">&quot;AddBannerMsg&quot;</span>, <span class="hljs-literal">null</span>);<br>        DispatcherHelper.CheckBeginInvokeOnUI(<span class="hljs-built_in">delegate</span><br>        &#123;<br>            BannerMessageControl.banner.ControlHandle(<span class="hljs-string">&quot;Command.Add&quot;</span> + Msg);<br>            <span class="hljs-comment">// 和 setData() 完全对应</span><br>            <span class="hljs-comment">// 相当于 BannerMessage.setData(&quot;Command.Add&quot; + Msg)</span><br>        &#125;);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>同时，这里再提出一种不需要修改班牌 dll 的自定义跑马灯的方法。</p><p>可以通过 <code>GarnitureControl</code> 插件服务类中的 <code>FindControlByKey()</code> 获取 <code>ControlHandle</code> 的 <code>Action&lt;object&gt;</code> 实例的引用（注：这时候也会返回一个 <code>UserControl</code> 类型的实例的引用，但是那个实例的引用是无法操纵的，这涉及到 UI 线程安全等等，不是讨论的重点），然后就可以控制 <code>GarnitureControl</code> 的行为了。</p><h2 id="二、关于-VisualBlock"><a href="#二、关于-VisualBlock" class="headerlink" title="二、关于 VisualBlock"></a>二、关于 VisualBlock</h2><h3 id="0-如何打开-localData-db"><a href="#0-如何打开-localData-db" class="headerlink" title="0. 如何打开 localData.db"></a>0. 如何打开 localData.db</h3><p>要理解以下代码，需要查看 localData.db 的内容。<br>考虑使用 SqliteStudio，加密算法 <code>System.Data.Sqlite: RC4</code>，密码 <code>123</code>。</p><h3 id="1-VisualBlock-的加载与初始化"><a href="#1-VisualBlock-的加载与初始化" class="headerlink" title="1. VisualBlock 的加载与初始化"></a>1. VisualBlock 的加载与初始化</h3><p>查看 <code>GS.Terminal.SmartBoard.Logic.VisualBlockCore.Startup</code>。</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-comment">// 此方法由于反编译出现了一定程度的混乱，但是不影响理解。</span><br><span class="hljs-function"><span class="hljs-keyword">internal</span> <span class="hljs-keyword">void</span> <span class="hljs-title">LoadVisualTemplate</span>()</span><br>&#123;<br>    <span class="hljs-keyword">try</span><br>    &#123;<br>        <span class="hljs-keyword">using</span> (Session session = Program.ObjectSpace.GetSession(ChannelMode.Multiton))<br>        <span class="hljs-comment">// 准备进行数据库操作</span><br>        <span class="hljs-comment">// 下面，以 Local_ 开头的 VisualPublish，VisualTemplate 等为数据库数据类型，</span><br>        <span class="hljs-comment">// 不含此开头的为用于 UI 显示的，根据数据库数据类型创建的实例</span><br>        &#123;<br>            <span class="hljs-keyword">this</span>.Templates.Clear();<br>            <span class="hljs-keyword">this</span>._ThemeName = <span class="hljs-built_in">string</span>.Empty;<br>            <span class="hljs-built_in">object</span> dblocker = <span class="hljs-keyword">this</span>._dblocker;<br>            <span class="hljs-comment">// 线程锁，防止多线程读写数据库时发生冲突</span><br>            <span class="hljs-keyword">lock</span> (dblocker)<br>            &#123;<br>                Local_Visual_Publish local_Visual_Publish = session.Query&lt;Local_Visual_Publish&gt;()<br>                    .FirstOrDefault((Local_Visual_Publish ss) =&gt; ss.TerminalID == Program.MachineId);<br>                <span class="hljs-comment">// 在数据库的 Local_Visual_Publish 表中，查询 TerminalID 键为此机器的 MachineID 的项</span><br>                <span class="hljs-comment">// 相当于 select * from Local_Visual_Publish where TerminalID = ...</span><br>                <span class="hljs-comment">// Visual_Publish 是一些基础的设置，比如默认的主题</span><br><br>                <span class="hljs-keyword">if</span> (local_Visual_Publish != <span class="hljs-literal">null</span>)<br>                &#123;<br>                    <span class="hljs-keyword">this</span>._ThemeName = local_Visual_Publish.ThemeName;<br>                    <span class="hljs-comment">// 将班牌的主题设为查询到的 Local_Visual_Publish 的 ThemeName 键的值</span><br><br>                    List&lt;Local_VisualTemplate&gt; templates = (<span class="hljs-keyword">from</span> ss <span class="hljs-keyword">in</span> local_Visual_Publish.Templates<br>                    <span class="hljs-keyword">orderby</span> ss.SortIndex<br>                    <span class="hljs-keyword">select</span> ss).ToList&lt;Local_VisualTemplate&gt;();<br>                    <span class="hljs-comment">// 这里需要指出两点：</span><br>                    <span class="hljs-comment">// 1. 为什么没有再单独查询 VisualTemplate？因为查询 VisualPublish 时，</span><br>                    <span class="hljs-comment">//    已经通过 GS.Unitive.Framework.Data.Xpo 相关内容自动获取了</span><br>                    <span class="hljs-comment">//    其 Publish 值应当与 MachineID 对应，参见本地数据库 localData.db 内容</span><br>                    <span class="hljs-comment">// 2. orderby 只是一个查询用的子句，这里进行了一个根据 SortIndex 从低到高的排序</span><br><br>                    <span class="hljs-built_in">int</span> num = <span class="hljs-number">1</span>;<br>                    Func&lt;Local_VisualBlock, VisualBlockItem&gt; &lt;&gt;<span class="hljs-number">9</span>__2;<br>                    <span class="hljs-keyword">foreach</span> (Local_VisualTemplate local_VisualTemplate <span class="hljs-keyword">in</span> templates)<br>                    &#123;<br>                        <span class="hljs-comment">// 遍历刚刚查询到的 Local_VisualTemplate</span><br><br>                        List&lt;BlockTemplate&gt; templates2 = <span class="hljs-keyword">this</span>.Templates;<br>                        <span class="hljs-comment">// 用来存储构造完毕的 BlockTemplate 的列表</span><br>                        <span class="hljs-comment">// 一个 BlockTemplate 相当于是一个滑动页面</span><br><br>                        BlockTemplate blockTemplate = <span class="hljs-keyword">new</span> BlockTemplate();<br>                        <span class="hljs-comment">// 创建新的 BlockTemplate 实例</span><br><br>                        blockTemplate.TemplateName = local_VisualTemplate.TemplateName;<br>                        <span class="hljs-comment">// 模板内部名称</span><br><br>                        blockTemplate.DisplayName = local_VisualTemplate.DisplayName;<br>                        <span class="hljs-comment">// 用于显示的名称（上方导航栏中显示，参见 GS.Terminal.SmartBoard.Logic.Garitures.ViewTabBarControl）</span><br><br>                        blockTemplate.Index = num++;<br>                        <span class="hljs-comment">// 索引</span><br><br>                        blockTemplate.TemplateType = BlockTemplateType.Theme;<br>                        <span class="hljs-comment">// 主题</span><br><br>                        IEnumerable&lt;Local_VisualBlock&gt; source = local_VisualTemplate.VisualBlocks.ToList&lt;Local_VisualBlock&gt;();<br>                        <span class="hljs-comment">// 获得该 VisualTemplate 下所有的 Local_VisualBlock 项目，准备遍历</span><br>                        <span class="hljs-comment">// 注意，这里获取到的 Local_VisualBlock 的 Template 键的值应该与 Local_VisualTemplate 的 TemplateID 对应</span><br>                        <span class="hljs-comment">// 参见数据库内容</span><br><br>                        Func&lt;Local_VisualBlock, VisualBlockItem&gt; selector;<br>                        <span class="hljs-comment">// 选择器，根据 Local_VisualBlock 创建相应的 VisualBlockItem</span><br><br>                        <span class="hljs-keyword">if</span> ((selector = &lt;&gt;<span class="hljs-number">9</span>__2) == <span class="hljs-literal">null</span>)<br>                        &#123;<br>                            selector = (&lt;&gt;<span class="hljs-number">9</span>__2 = <span class="hljs-built_in">delegate</span>(Local_VisualBlock b)<br>                            &#123;<br>                                BaseBlock blockEntity = <span class="hljs-literal">null</span>;<br>                                DispatcherHelper.RunAsync(<span class="hljs-built_in">delegate</span><br>                                &#123;<br>                                    blockEntity = <span class="hljs-keyword">this</span>.GetBlock(b.BlockTypeName);<br>                                    <span class="hljs-comment">// 获取相应的 Block</span><br>                                    <span class="hljs-comment">// 这里是一个对 GS.Terminal.VisualBlock.Service.GetBlock(string key) 的封装</span><br>                                    <span class="hljs-comment">// 获取 /GS.Terminal.VisualBlock/Bundles/ 下 .dll 中</span><br>                                    <span class="hljs-comment">// 含有属性 [ExportMetadata(&quot;Name&quot;, &lt;key&gt;)] ，且继承了 BaseBlock 类的各种 Block</span><br><br>                                    blockEntity.DataSource = (b.DataSource.StartsWith(<span class="hljs-string">&quot;http&quot;</span>) ? b.DataSource : (Program.WebPath + <span class="hljs-string">&quot;/&quot;</span> + b.DataSource));<br>                                    blockEntity.Init(Program.AddonContext);<br>                                    <span class="hljs-comment">// 初始化 Block，设置远程数据 api 等</span><br>                                &#125;).Wait();<br>                                <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">string</span>.IsNullOrEmpty(b.NavTemplateName))<br>                                &#123;<br>                                    blockEntity.NavPageIndex = templates.FindIndex((Local_VisualTemplate ss) =&gt; ss.TemplateName == b.NavTemplateName) + <span class="hljs-number">1</span>;<br>                                &#125;<br>                                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> VisualBlockItem<br>                                &#123;<br>                                    Id = Guid.Parse(b.BlockID),<br>                                    <span class="hljs-comment">// ID</span><br><br>                                    <span class="hljs-comment">// 从这里开始的几项都可以在数据库的 Local_VisualBlock 表中找到</span><br>                                    BlockComponent = b.BlockComponent,<br>                                    <span class="hljs-comment">// block 的内容，相当于一个描述，没有实际作用</span><br><br>                                    BlockTypeName = b.BlockTypeName,<br>                                    <span class="hljs-comment">// block 类型名称</span><br>                                    DataSource = b.DataSource,<br>                                    <span class="hljs-comment">// 远程 api</span><br>                                    NavTemplateName = b.NavTemplateName,<br>                                    <span class="hljs-comment">// 导航栏名称等等</span><br><br>                                    Height = b.Height,<br>                                    Width = b.Width,<br>                                    X = b.X,<br>                                    Y = b.Y,<br>                                    <span class="hljs-comment">// 位置</span><br>                                    <span class="hljs-comment">// 数据库中包含的键值结束</span><br>                                    DataContext = blockEntity<br>                                    <span class="hljs-comment">// block 的内容</span><br>                                &#125;;<br>                            &#125;);<br>                        &#125;<br>                        blockTemplate.Blocks = source.Select(selector).ToList&lt;VisualBlockItem&gt;();<br>                        <span class="hljs-comment">// 将生成了的 Block 全部添加到 blockTemplate</span><br>                        templates2.Add(blockTemplate);<br>                        <span class="hljs-comment">// 添加生成了的 blockTemplate 到所有 BlockTemplate 的列表</span><br>                    &#125;<br>                &#125;<br>            &#125;<br>            DataUpdate.Instance.RebuildUpdateList();<br>            <span class="hljs-comment">// 重新生成数据刷新列表</span><br>            session.Disconnect();<br>            <span class="hljs-comment">// 断开数据库连接</span><br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">catch</span> (Exception errorException)<br>    &#123;<br>        Program.AddonContext.Logger.Error(<span class="hljs-string">&quot;加载主题模版异常&quot;</span>, errorException);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="2-VisualBlock-如何获取数据？"><a href="#2-VisualBlock-如何获取数据？" class="headerlink" title="2. VisualBlock 如何获取数据？"></a>2. VisualBlock 如何获取数据？</h3><p>在刚刚的加载过程中，<code>RebuildUpdateList()</code> 方法创建了一个列表，其内容为依据实例化了的各种 <code>VisualBlock</code> 创建的一系列 <code>UpdateBlock</code>，用于管理 VisualBlock 数据的获取和更新。</p><p>不过注意，<code>UpdateBlock</code> 类只是描述了一个数据结构，实际的逻辑并不在此处。</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">UpdateBlock</span><br>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">UpdateBlock</span>(<span class="hljs-params">VisualBlockItem item</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">this</span>.BlockEntity = (IUpdate)item.DataContext;<br>        <span class="hljs-comment">// 相当于 Block 的内容</span><br>        <span class="hljs-comment">// 这里强制类型转换为 IUpdate 是为了在后面使用这个 Block 实现的 IUpdate 接口的 LoadLocalData() 方法</span><br>        <span class="hljs-keyword">this</span>.BlockId = item.Id;<br>        <span class="hljs-keyword">this</span>.TypeName = item.BlockTypeName;<br>        <span class="hljs-keyword">this</span>.WebRequester = <span class="hljs-keyword">new</span> VisualBlockWebRequest(<span class="hljs-keyword">new</span> Uri(Program.localSetting.GlobalConfig.WebPath + <span class="hljs-string">&quot;/&quot;</span> + item.DataSource), <br>        <span class="hljs-built_in">string</span>.Format(<span class="hljs-string">&quot;&#123;0&#125;_&#123;1&#125;.json&quot;</span>, item.BlockTypeName, item.Id));<br>        <span class="hljs-comment">// 指定了获取数据的 api 和数据存储路径</span><br>        <span class="hljs-comment">// 班牌目录下 /cache/BlockCache/ 下的 json 文件就是这么来的</span><br>    &#125;<br>    ...<br>&#125;<br></code></pre></td></tr></table></figure><p>下面展示的两个方法控制 Block 数据的更新。其中，<code>UpdateAllBlock()</code> 方法会在 <code>GS.Terminal.SmartBoard.Logic</code> 插件启动时被调用。</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-comment">// GS.Terminal.SmartBoard.Logic.VisualBlockCore.DataUpdate</span><br><br><span class="hljs-comment">// Token: 0x06000256 RID: 598 RVA: 0x0000BB54 File Offset: 0x00009D54</span><br><span class="hljs-function"><span class="hljs-keyword">internal</span> <span class="hljs-keyword">void</span> <span class="hljs-title">UpdateAllBlock</span>()</span><br>&#123;<br>    <span class="hljs-keyword">foreach</span> (<span class="hljs-built_in">string</span> typeName <span class="hljs-keyword">in</span> <span class="hljs-keyword">this</span>._updateBlocks.Keys)<br>    &#123;<br>        <span class="hljs-keyword">this</span>.UpdateBlockDataByTypeName(typeName);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// Token: 0x06000257 RID: 599 RVA: 0x0000BBAC File Offset: 0x00009DAC</span><br><span class="hljs-function"><span class="hljs-keyword">internal</span> <span class="hljs-keyword">void</span> <span class="hljs-title">UpdateBlockDataByTypeName</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> typeName</span>)</span><br>&#123;<br>    List&lt;UpdateBlock&gt; list;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._updateBlocks.TryGetValue(typeName, <span class="hljs-keyword">out</span> list))<br>    &#123;<br>        list.ForEach(<span class="hljs-built_in">delegate</span>(UpdateBlock b)<br>        &#123;<br>            <span class="hljs-comment">// 遍历 UpdateBlock</span><br>            <span class="hljs-keyword">if</span> (!b.IsBusy)<br>            &#123;<br>                <span class="hljs-keyword">try</span><br>                &#123;<br>                    b.IsBusy = <span class="hljs-literal">true</span>;<br>                    <span class="hljs-keyword">if</span> (b.WebRequester.UpdateData() == VisualBlockUpdateResult.Update)<br>                    <span class="hljs-comment">// 先从远程 api 获取数据到本地的 json 文件</span><br>                    &#123;<br>                        b.BlockEntity.LoadLocalData(b.WebRequester.CacheFile);<br>                        <span class="hljs-comment">// 调用该 Block 实现的 IUpdate 的 LoadLocalData() 方法</span><br>                        <span class="hljs-comment">// 注意！类似的写法可以用于人为修改 Block 的内容！</span><br>                        <span class="hljs-comment">// 比如在“班级风采”播放自定义视频等等</span><br><br>                        <span class="hljs-comment">// 此外，每个 VisualBlock 的 json 数据结构都各有差别，但基本都包含一个 result 节点</span><br>                        <span class="hljs-comment">// 有些 VisualBlock 从服务器获取到的 json 数据结构的 result 节点的内容是经过 gzip 压缩的</span><br>                        <span class="hljs-comment">// 比如 RichNotice 等</span><br>                    &#125;<br>                &#125;<br>                <span class="hljs-keyword">finally</span><br>                &#123;<br>                    b.IsBusy = <span class="hljs-literal">false</span>;<br>                &#125;<br>            &#125;<br>        &#125;);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>这些逻辑就是实现班牌滑动页面上控件更新的全部了。</p><p>仿照这样的逻辑，我们可以写一个人为创建自定义 VisualTemplate 的代码</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">RewriteVisualTemplate</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> template_name, <span class="hljs-built_in">string</span> display_name, <span class="hljs-built_in">int</span> template_overwrite_index, List&lt;VisualBlockItem&gt; items</span>)</span><br>&#123;<br>    BlockTemplate blockTemplate = <span class="hljs-keyword">new</span> BlockTemplate();<br>    blockTemplate.TemplateName = template_name;<br>    blockTemplate.DisplayName = display_name;<br>    blockTemplate.Index = template_overwrite_index;<br>    blockTemplate.TemplateType = BlockTemplateType.Theme; <br>    <span class="hljs-comment">// enum BlockTemplateType.Theme = 0x0</span><br><br>    blockTemplate.Blocks = items;<br>    <span class="hljs-comment">// 这里需要指出的是，其实 BlockTemplate 的 List&lt;VisualBlockItem&gt; Blocks 没有在 BlockTemplate 的构造函数中实例化，需要手动实例化</span><br>    <span class="hljs-comment">// 此外，一个 BlockTemplate 可能包含多个 VisualBlockItem，比如首页</span><br><br>    blockTemplate.Previous = Utilites.ViewModelLocator.MainPage.TemplateList[template_overwrite_index - <span class="hljs-number">1</span>];<br>    blockTemplate.Next = Utilites.ViewModelLocator.MainPage.TemplateList[template_overwrite_index + <span class="hljs-number">1</span>];<br><br>    <span class="hljs-comment">// 滑动页面的切换实际上用的是一个类似链表的结构，所以可以这样替换</span><br>     DispatcherHelper.RunAsync(<br>        () =&gt;<br>        &#123;<br>            <span class="hljs-comment">// DispatcherHelper 为 Mvvm 的内容</span><br>            <span class="hljs-comment">// (GS.Terminal.SmartBoard.Logic.Core.)Utilites 为 GS 的杂项工具</span><br>            Utilites.ViewModelLocator.MainPage.TemplateList[template_overwrite_index] = blockTemplate;<br>            <span class="hljs-comment">// 执行替换</span><br>        &#125;<br>    );<br>&#125;<br><br><span class="hljs-comment">// 创建 VisualBlockItem</span><br><span class="hljs-comment">// 参数与 localData.db 中的键对应</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> VisualBlockItem <span class="hljs-title">GetBlock</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> block_name, <span class="hljs-built_in">string</span> json_filename, <span class="hljs-built_in">string</span> component, <span class="hljs-built_in">int</span> width, <span class="hljs-built_in">int</span> height, <span class="hljs-built_in">int</span> x, <span class="hljs-built_in">int</span> y, <span class="hljs-built_in">string</span> data_source = <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-built_in">string</span> nav_template_name = <span class="hljs-string">&quot;&quot;</span></span>)</span><br>&#123;<br><br>    IBlockService firstOrDefaultService = Program.AddonContext. GetFirstOrDefaultService&lt;IBlockService&gt;(<span class="hljs-string">&quot;GS.Terminal.VisualBlock&quot;</span>);<br>    <span class="hljs-comment">// 获取 VisualBlock 有关服务</span><br>    BaseBlock block = firstOrDefaultService.GetBlock(block_name);<br>    block.Init(Program.AddonContext);<br><br>    IUpdate update = (IUpdate)block;<br>    update.LoadLocalData(media_json_filename);<br><br><br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> VisualBlockItem<br>    &#123;<br>        Id = Guid.NewGuid(),<br>        BlockComponent = component,<br>        BlockTypeName = ((IBlock)block).TypeName,<br>        DataSource = data_source,<br>        NavTemplateName = nav_template_name,<br>        Width = width,<br>        Height = height,<br>        X = x,<br>        Y = y,<br>        DataContext = (BaseBlock)update<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="3-一种可能的不需要修改-dll-的添加自定义-VisualBlock-的方法"><a href="#3-一种可能的不需要修改-dll-的添加自定义-VisualBlock-的方法" class="headerlink" title="3. 一种可能的不需要修改 dll 的添加自定义 VisualBlock 的方法"></a>3. 一种可能的不需要修改 dll 的添加自定义 VisualBlock 的方法</h3><p>另外，这里再提出一种不需要修改 dll 的方法。</p><p>使用 <code>GS.Terminal.LogicShell</code> 的 <code>IViewHelperService</code> 或者 <code>GalaSoft.MvvmLight</code> 的 <code>SimpleIoc</code> 获取相关的 ViewModel，再进行操作。</p>]]></content>
    
    
    
    <tags>
      
      <tag>通软系列软件</tag>
      
      <tag>.Net</tag>
      
      <tag>C#</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>我们最终都会坦然接受一切</title>
    <link href="/2025/12/04/%E6%88%91%E4%BB%AC%E6%9C%80%E7%BB%88%E9%83%BD%E4%BC%9A%E5%9D%A6%E7%84%B6%E6%8E%A5%E5%8F%97%E4%B8%80%E5%88%87/"/>
    <url>/2025/12/04/%E6%88%91%E4%BB%AC%E6%9C%80%E7%BB%88%E9%83%BD%E4%BC%9A%E5%9D%A6%E7%84%B6%E6%8E%A5%E5%8F%97%E4%B8%80%E5%88%87/</url>
    
    <content type="html"><![CDATA[<p><img src="/img/post/2025-12/01/01.jpg"></p><p>玩了某白俄作者做的视觉小说。现在国内几个汉化都是机翻，所以我还是老老实实玩原版吧，至于有些地方要是理解错了那也没奈何了。我认为这个风格和设定有成为小众时尚单品的潜力，不过这点暂且按下不表。</p><p>比较有趣的是这个作者最后提到一个词，也就是 <strong>cynic</strong>。Vorkuta-5 这个城市里的研究机构进行着某种出于所谓“对于这个世界 <strong>cynic</strong> 的想法”而进行的改变现实的实验，而最后也因为进行这样的实验，在现实自动修复的时候，被整个从现实中抹去了。作者借 Asya 说 Vorkuta-5 的这种出于厌世而进行的实验，实际上是在现实上剌了一个伤口，而 Vorkuta-5 的被抹去则被形容为是伤口的愈合，Asya 和作者实际上是反对这种厌世的态度的，不管是个人的厌世，到 Vorkuta-5 的研究机构及这个城市本身所承载着的厌世，乃至是苏联解体前夕，甚至解体后一直延续到现在的俄联邦和一些前加盟国的体制化的巨大的厌世（这可以被称为一种左翼忧郁症的表现吗？也不尽然）。既然这种厌世的、犬儒的一种方案不行，那么我们到底应该怎么做、做什么呢？</p><p><strong>那就是爱呀。</strong>（泉此方并感）</p><p>作者借女主 Asya 之口给出的答案是，无论这个世界发生奇迹或者异常，承认并顺着这个世界的某种总括性的、必然性的大的趋势或者趋向走下去就行了，同时更重要的是，也要爱着这世界上的一切，哪怕这个世界和现实对我们似乎并不是十分的友好。而作为这一切的结局呢，女主连同整个 Vorkuta-5 的居民被抹消后，给这个世界留下的，也只剩下某种 <em>永不消逝的电波</em> （笑），不停重复着她对这个世界的爱：I love you。</p><p>这种观点是否合适，我在这里不作评价。不过有些时候觉得自己还是太 cynic 了一点，但是一方面是 cynic 一方面也没有什么动作，自己一个人越 cynic 越是郁闷的很，这么一比较下来，似乎还不如就这样顺其自然，和 Asya 扒电塔一样扒到圭峰山或者随便哪个高高的山岗上，然后立在地球边上呼唤爱呢。</p><p>但是现在不准爬秦岭了，可能上午呼唤爱下午就挨处分了（笑）。</p><p>……</p><blockquote><p>“如果你真的越过去了！一切都不会改变的！不会有任何悬念的！我们才二十岁，生活，生活还很漫长！……”罗炒蚊语无伦次，他甚至爆典了“我们肯定会在以后改变一些观点的，一个人要有多大的激情才能始终保持自己人格的一致！不会存在这种人的，就算存在，也没人会记得他们！！所以他们都会从世界上消失的！”</p></blockquote><p>我们最终都会坦然接受一切。</p><p><img src="/img/post/2025-12/01/02.jpg"></p><p>以及 Ira 好帅😭😭😭</p>]]></content>
    
    
    
    <tags>
      
      <tag>杂谈</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>「粘连科技」的中之人是谁？</title>
    <link href="/2025/10/18/%E3%80%8C%E7%B2%98%E8%BF%9E%E7%A7%91%E6%8A%80%E3%80%8D%E7%9A%84%E4%B8%AD%E4%B9%8B%E4%BA%BA%E6%98%AF%E8%B0%81%EF%BC%9F/"/>
    <url>/2025/10/18/%E3%80%8C%E7%B2%98%E8%BF%9E%E7%A7%91%E6%8A%80%E3%80%8D%E7%9A%84%E4%B8%AD%E4%B9%8B%E4%BA%BA%E6%98%AF%E8%B0%81%EF%BC%9F/</url>
    
    <content type="html"><![CDATA[<p>粘连科技应该是 bilibili 科技区&#x2F;数码区最具争议性的创作者之一。早期他制作了相当多人民群众喜闻乐见的科普视频。然而在量子虫洞事件后，他的视频风格逐渐变得十分诡异，彻底成为了亚文化梗的随机缝合。然后他（至少以“粘连科技”这个名义活动的他）就突然隐退了。后面虽然出现了诸如网络小白Uncle城（有必要指出 Uncle城 的水平实在太过低级十分堪忧，说他的视频能当代餐都是抬举他了。而且他还有拿死人——网络死人——炒作起号之嫌疑，米线在哪？）等模仿者，但再也没有任何一个人能达到粘连科技的高度。同时粘连科技也是十分神秘的一个人：几乎没有人能够成功发掘出他的中之人个人信息，甚至大部分人对他的经历都知之甚少——有人说他是北邮的学生，有人说他润日了，但没人清楚事实如何。</p><p>本人试图从别的地方入手，发掘他的真实信息。</p><p>众所周知，粘连科技以前曾经使用的名义是网络油饼。</p><p><a href="https://github.com/VirtualOilCake">VirtualOilCake </a></p><p>而这是他的 Github Profile。里面公开的粘连皮套也证实了这一点。</p><p>他的 profile repo commit history 里面虽然有几个链接，但是无一例外都失效了。</p><p>但是他这个账号的名字并非网络油饼，而是 TheInterestingSoul，这个旧的 profile repo 也没有删掉。</p><p>而这里面就有几个链接。</p><p>分别指向 bilibili 知乎 网易云等。网易云之前显示是一个四川泸州的账号，但是现在好像被注销了。知乎仍在活动，IP 四川，而且是一如既往的进行奇妙发言。bilibili 则发布了一个“补档”。至于补档谁呢？答案是他在 youtube 的另一个名义 Inukai Yui。IP 同样显示四川。</p><p><a href="https://space.bilibili.com/130892654">YetAnotherDowya的个人空间-YetAnotherDowya个人主页-哔哩哔哩视频</a></p><p>前段时间他似乎在 youtube 开了个新号叫 Soiri Lab 发了个给 BF 语言实现 JIT 的视频，随后被搬到 bilibili。有人怀疑这个是不是粘科秽土转生了，然后评论区这个 YetAnotherDowya 还发言了。</p><p><a href="https://www.bilibili.com/video/BV1rzZtYAEss/">Making a Brainf＊＊＊ JIT Compiler in Rust!_哔哩哔哩_bilibili</a></p><p>如果真是他本人，这个高强度自搜确实幽默。</p><p>此外 github 那边 commit history 还能找到的信息是他的邮箱地址，是一个叫 wangpy 的人。</p><p>我们至今不能知道 wangpy 同学去了何方。润日说大概率是胡编乱造。更有可能的是（从他以网络油饼名义发布的漫画——此外，这个漫画——以他自己的部分生活为原型——中的一些细节似乎可以交叉验证四川人说）他在润日失败复读失败等一连串事件后，最后哪里也没去成。这个结局多少也是有点令人唏嘘了。</p><p>另外，oier db 上面有一个高中毕业两年的四川王鹏宇，曾经在成都嘉祥外国语上初中。至于和粘连科技有没有关系就不知道了，因为这个时间只能勉强和网络油饼漫画里面的时间附会上。有必要一提的是粘科可能确实有过oi经验。</p>]]></content>
    
    
    
    <tags>
      
      <tag>杂谈</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>海蜇</title>
    <link href="/2025/08/06/%E6%B5%B7%E8%9C%87/"/>
    <url>/2025/08/06/%E6%B5%B7%E8%9C%87/</url>
    
    <content type="html"><![CDATA[<blockquote><p>突然想吃肥肠了。</p><p>最早去江油那边是吃老君路的川罗肥肠，毕竟老店有口皆碑，后来在市区开了分店，也就没必要专程驱车小五十公里去吃了，反正味道大差不差；后来在青莲镇吃一家叫什么杨肥肠还是伍肥肠的店，对面就是李白故里景区。但是从来没进去看过，李白又没有坐在里面为什么要去看。一般吃完就直接开车回绵阳了。</p><p>平时的早上可以吃肥肠米粉。据说起源是开元镇，所以现在很多店都叫某某开元米粉。但是去开元镇吃过，感觉很一般，不如园艺山上面一家胖米粉，胖米粉不如我家旁边的米粉。</p><p>不知道以后看见红烧肥肠或者粉蒸肥肠或者蘸水肥肠的时候会作何感想。也有可能什么感想都没有吧。毕竟我时常忘事。</p><p>然后莫名想到某首海鲜曲。翻译不是我做的。</p></blockquote><p>抬起头望着天空</p><p>发现有什么东西漂浮在空中</p><p>睁大了双眼去细细端详</p><p>原来是一只巨大的海蜇</p><p>它的身材与人类的一般的大</p><p>却飞在空中比电线杆的高度还要高</p><p>它如何来到这座小镇呢</p><p>又是为了什么而到来呢</p><p>在外面匆匆行走的人们</p><p>接二连三地戴上头盔</p>]]></content>
    
    
    
    <tags>
      
      <tag>日常</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>optional-和一些杂七杂八的容器的一个小问题</title>
    <link href="/2025/08/04/optional-%E5%92%8C%E4%B8%80%E4%BA%9B%E6%9D%82%E4%B8%83%E6%9D%82%E5%85%AB%E7%9A%84%E5%AE%B9%E5%99%A8%E7%9A%84%E4%B8%80%E4%B8%AA%E5%B0%8F%E9%97%AE%E9%A2%98/"/>
    <url>/2025/08/04/optional-%E5%92%8C%E4%B8%80%E4%BA%9B%E6%9D%82%E4%B8%83%E6%9D%82%E5%85%AB%E7%9A%84%E5%AE%B9%E5%99%A8%E7%9A%84%E4%B8%80%E4%B8%AA%E5%B0%8F%E9%97%AE%E9%A2%98/</url>
    
    <content type="html"><![CDATA[<p>今天看 Jason Turner 的视频才发现，原来我之前用 <code>std::optional</code> 之类的容器的方法并不一定合适（怎么听起来这么像营销号）。Turner 自己也吐槽自己的视频起的很标题党，不过我看了以后觉得其实还好，而且这些容器使用最佳实践的问题我真没太想过。所以写下来记一下。</p><p>比如说这样的代码：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Container</span> &#123;<br>    <span class="hljs-type">int</span> x;<br>    <span class="hljs-built_in">Container</span>(<span class="hljs-type">int</span> x) : <span class="hljs-built_in">x</span>(x) &#123;&#125;<br>&#125;;<br><br><span class="hljs-function">std::optional&lt;Container&gt; <span class="hljs-title">get_value</span><span class="hljs-params">()</span> </span>&#123;<br>    std::optional&lt;Container&gt; ret;<br>    ret = <span class="hljs-built_in">Container</span>(<span class="hljs-number">42</span>);<br>    <span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure><p>这中间会有一个移动构造，因为 <code>= Container(42)</code> 那里右边是个 prvalue。然后把这个 <code>ret</code> 返回出去。</p><p>之前我如果简写的话，会写成这样：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">return</span> Container&#123;<span class="hljs-number">42</span>&#125;;<br></code></pre></td></tr></table></figure><p>但是 Turner 说这里还是会调用一下移动构造（隐式构造一个 <code>std::optional</code> ）。他说这样其实不是非常的 RVO 友好。</p><p>我自己也拿 Compiler Explorer 试了一下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs asm">call std::optional&lt;LifeMonitor&gt;::optional&lt;LifeMonitor, true&gt;(LifeMonitor&amp;&amp;)<br></code></pre></td></tr></table></figure><figure class="highlight delphi"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs delphi">value_init -&gt; Param <span class="hljs-function"><span class="hljs-keyword">Constructor</span><span class="hljs-params">(42)</span></span><br><span class="hljs-function"><span class="hljs-title">move_of_value_init</span> -&gt; <span class="hljs-title">Move</span> <span class="hljs-title">Constructor</span> <span class="hljs-title">from</span> <span class="hljs-title">value_init</span></span><br><span class="hljs-function"><span class="hljs-title">value_init</span> -&gt; <span class="hljs-title">Destructor</span></span><br><span class="hljs-function"><span class="hljs-title">move_of_value_init</span> -&gt; <span class="hljs-title">Destructor</span></span><br></code></pre></td></tr></table></figure><p>好吧还真是。等于说刚才两段代码是等价的。</p><p>其实还是有 copy elision 的，就是最后那个隐式生成的 optional 作为返回值是被 NRVO 优化了的。但是，可能有些时候我们以为编译器优化的会更彻底一些，比如说直接在调用方的栈空间里面就地构造这个对象，从而避免这个多余的移动赋值，但是编译器实际上并没有进行这个优化。</p><p>我看评论区有 Rustacean 说什么 Rust 就可以对这种东西进行比较好的优化因为默认移动云云（唉，r批）。他说的可能有一定道理，因为在语义约束更严格的时候，确实可能有利于编译器进行更激进的优化。不过比较可惜的是，他并没有给出佐证他的论断的证据。</p><p>鉴于我现在还是用的 C++，所以还是回到 C++ 上来。Turner 的建议是，如果要保证 RVO 或者 NRVO 能够应用，最好写成这样：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs cpp">std::optional&lt;Container&gt; ret;<br>ret.<span class="hljs-built_in">emplace</span>(<span class="hljs-number">42</span>);<br><span class="hljs-keyword">return</span> ret;<br></code></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">return</span> std::optional&lt;Container&gt;&#123;<span class="hljs-number">42</span>&#125;;<br></code></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">return</span> std::<span class="hljs-built_in">optional</span>&lt;Container&gt;(std::in_place, <span class="hljs-number">42</span>);<br></code></pre></td></tr></table></figure><figure class="highlight delphi"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs delphi">value_init -&gt; Param <span class="hljs-function"><span class="hljs-keyword">Constructor</span><span class="hljs-params">(42)</span></span><br><span class="hljs-function"><span class="hljs-title">value_init</span> -&gt; <span class="hljs-title">Destructor</span></span><br></code></pre></td></tr></table></figure><p>看汇编也没有那个移动构造了。</p><p>这三种方法都可以。这样一方面能够应用 RVO&#x2F;NRVO，也能够保证 optional 里面的对象是就地构造的，没有多余的移动构造。pair&#x2F;tuple 什么的也是一个道理。</p><p>评论里面还有个哥们指出了一点我觉得很有道理，他说返回值是 <code>std::optional</code> 或者 <code>std::expected</code> 这一类的东西的代码一般都有分支，比如说：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function">std::optional&lt;Container&gt; <span class="hljs-title">get_value</span><span class="hljs-params">(<span class="hljs-type">int</span> n)</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (n == <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">return</span> std::<span class="hljs-literal">nullopt</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> std::optional&lt;Container&gt;&#123;<span class="hljs-number">42</span>&#125;;<br>&#125;<br></code></pre></td></tr></table></figure><p>这样编译器又不能进行激进优化了，移动赋值又要冒出来。所以他建议如果没必要返回 optional 或者 expected 就不要返回它，好让编译器正常进行优化。</p><p>其实这个问题并不是非常严重。我之前虽然知道这个隐式移动构造的事情，但是确实也没太往优化这方面想过，所以写下来记录一下。</p>]]></content>
    
    
    
    <tags>
      
      <tag>C++</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>去西安 GDG 耍了一圈</title>
    <link href="/2025/07/05/%E5%8E%BB%E8%A5%BF%E5%AE%89-GDG-%E8%80%8D%E4%BA%86%E4%B8%80%E5%9C%88/"/>
    <url>/2025/07/05/%E5%8E%BB%E8%A5%BF%E5%AE%89-GDG-%E8%80%8D%E4%BA%86%E4%B8%80%E5%9C%88/</url>
    
    <content type="html"><![CDATA[<p>正好这两天西安 GDG 搞活动，就去凑了下热闹。</p><p>去的比较早，十点就到地方了，在旁边瑞幸坐了一会。十一点去吃了碗面。回来人家还有一个半小时才开始呢。</p><p><img src="/img/post/2025-07/01/01.jpg"></p><p>氛围挺好。不过那碗面发力了导致我有点晕碳。</p><p><img src="/img/post/2025-07/01/02.jpg"></p><p>最后做完了 codelab 发了个电脑包。</p><p><img src="/img/post/2025-07/01/03.jpg"></p><p>回学校以后依然是吃定番的水之源川菜馆。</p>]]></content>
    
    
    
    <tags>
      
      <tag>日常</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>炮打 EasyX</title>
    <link href="/2025/06/30/%E7%82%AE%E6%89%93-EasyX/"/>
    <url>/2025/06/30/%E7%82%AE%E6%89%93-EasyX/</url>
    
    <content type="html"><![CDATA[<blockquote><p><strong>TL;DR</strong>：EasyX 就是纯纯的垃圾，别用。入门建议用 SFML。</p></blockquote><h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><blockquote><p>之前一直没写什么东西，现在期末考完没啥事情正好写一点。</p></blockquote><p>这个学期软院开了个什么”信息技术基础认知与实践“的课，就是期末提出来那么两周，每周两次，每次四个课时给你写代码，要求最后一个人能写个小项目。我选的是 C++ 方向。然后我把之前选课指导里面写的东西贴在这里：</p><blockquote><p>主要内容包括面向对象设计模式、操作系统与应用程序、句柄与回调函数设计、消息映射、软件项目管理、游戏设计基础、图形动画处理等。要求学生掌握面向对象设计模试；掌握操作系统与应用程序关系；了解程序与柄关系；掌握软件产生与周期；掌握游戏开发流程，场景；掌握常用图形处理API；并通过完整的项目案例分析和成果展示，使学生掌握桌面应用项目开发的流程，培养团队协作的能力。其中，面向对象设计模式和游戏设计基础是学习重点，操作系统与应用程序和软件项目管理是难点。</p></blockquote><p>好吧……其实这个地方是画了很大个大饼。首先之前就没给人讲过的环境配置这次还是没讲清楚，构建系统仍然是讲都不讲，最后不知道从哪里掏出来个 VC++6 我一口老血差点没吐出来，然后上面的人在那讲，下面的人傻呵呵的跟着做，不是你们都不觉得哪里有问题吗？然后版本控制也不介绍。最后，四四十六个课时，后八个课时讲了一点面向对象和项目组织，有节课 lecturer 嗯是被一个简单的循环依赖问题硬控整整一个半小时；前八个课时全在讲 EasyX，我们今天的主角。</p><h2 id="炮打-EasyX：作为垃圾的入门框架"><a href="#炮打-EasyX：作为垃圾的入门框架" class="headerlink" title="炮打 EasyX：作为垃圾的入门框架"></a>炮打 EasyX：作为垃圾的入门框架</h2><blockquote><p>优点？为什么要谈优点？</p><p>as if 我只要谈了优点，就有什么人就会连连说，萌哥中肯，分析井井有条还不失客观性一样，或者 EasyX 的孝子贤孙们（存在这种人吗？）看到了就不会对我有意见一样。</p><p>显然，我是来批判的，不是来装中肯的。虚情假意写一点优点不如不写。</p></blockquote><p>主要针对 EasyX 及其作者个人存在的以下几个重大问题（甚至毫不客气地说，重大弊病）进行讨论。</p><ol><li><p>API 严重的平台特定性</p></li><li><p>糟糕的设计和令人不明所以的文档</p></li><li><p>作者本人令人迷惑的运营能力</p></li></ol><h3 id="严重的平台特定性问题"><a href="#严重的平台特定性问题" class="headerlink" title="严重的平台特定性问题"></a>严重的平台特定性问题</h3><p>这个东西真的是一看便知。首先让我们看到 <code>easyx.h</code>：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;windows.h&gt;</span></span><br></code></pre></td></tr></table></figure><p><strong>I mean, what the hell?</strong></p><p>一上来就给人干绷不住了。如果 EasyX 只是个学生作业我觉得无可厚非，但是 EasyX 在事实上已经一个被很多机构甚至是部分高校用作教学的得到广泛应用的项目了，然而这么一个项目却根本没法覆盖到全部场景——你凭什么假定我就使用的是 Windows？这时候有人就要说了，你装个 MinGW 工具链不就好了。没错，但是作为一个大项目就要有大项目的担当。一方面标榜着 Easy，一方面又要让<strong>刚刚入门的用户</strong>去事必躬亲地处理各种细节问题，我认为这么做并不合适。</p><p>EasyX 事实上仅仅是在 GDI 外面套了薄薄的一层壳子，<strong>封装了约等于没有封装，简化了约等于没简化</strong>，那么我就想问了，用它的意义何在，为什么我不直接去调 GDI。</p><h3 id="垃圾的设计、垃圾的文档"><a href="#垃圾的设计、垃圾的文档" class="headerlink" title="垃圾的设计、垃圾的文档"></a>垃圾的设计、垃圾的文档</h3><p>首先，命名极其随意。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function">COLORREF <span class="hljs-title">getlinecolor</span><span class="hljs-params">()</span></span>;            <span class="hljs-comment">// Get line color</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">setlinecolor</span><span class="hljs-params">(COLORREF color)</span></span>;    <span class="hljs-comment">// Set line color</span><br><span class="hljs-function">COLORREF <span class="hljs-title">gettextcolor</span><span class="hljs-params">()</span></span>;            <span class="hljs-comment">// Get text color</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">settextcolor</span><span class="hljs-params">(COLORREF color)</span></span>;    <span class="hljs-comment">// Set text color</span><br><span class="hljs-function">COLORREF <span class="hljs-title">getfillcolor</span><span class="hljs-params">()</span></span>;            <span class="hljs-comment">// Get fill color</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">setfillcolor</span><span class="hljs-params">(COLORREF color)</span></span>;    <span class="hljs-comment">// Set fill color</span><br></code></pre></td></tr></table></figure><p>好的，我们注意到作者同志似乎不太喜欢断句。这种非 camel case 非 snake case 的颇具淳古之风的没有脑血栓想不出来的命名法实在是令人大为震撼。不过至少还算中立邪恶，没有用拼音或者谜之缩写……</p><p><strong>没有吗？</strong></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function">COLORREF <span class="hljs-title">getbkcolor</span><span class="hljs-params">()</span></span>;                <span class="hljs-comment">// Get background color</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">setbkcolor</span><span class="hljs-params">(COLORREF color)</span></span>;    <span class="hljs-comment">// Set background color</span><br></code></pre></td></tr></table></figure><p>当我没说。好的我又想问了，作者同志是真的惜字如金啊，一个 background 嗯是给他缩写成 bk 了。好好写完一个词很难吗。有没有一种可能现在大家写代码都有提示了，多写点少写点其实没有什么区别。如果作者同志真的想要整点仿古的北欧性冷淡极简风代码给我这种土鳖开开眼，为什么不缩写成 C 标准库里面那种 6 字神人函数名。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">settxc</span><span class="hljs-params">(...)</span></span>;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">setbkc</span><span class="hljs-params">(...)</span></span>;<br></code></pre></td></tr></table></figure><p>可能我确实有点极端了，至少人家命名风格还是相对统一的……</p><p><strong>是这样吗？</strong></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">BeginBatchDraw</span><span class="hljs-params">()</span></span>;    <span class="hljs-comment">// Begin batch drawing mode</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">FlushBatchDraw</span><span class="hljs-params">()</span></span>;    <span class="hljs-comment">// Refreshes the undisplayed drawing</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">FlushBatchDraw</span><span class="hljs-params">(<span class="hljs-type">int</span> left, <span class="hljs-type">int</span> top, <span class="hljs-type">int</span> right, <span class="hljs-type">int</span> bottom)</span></span>;    <span class="hljs-comment">// Refreshes the undisplayed drawing</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">EndBatchDraw</span><span class="hljs-params">()</span></span>;    <span class="hljs-comment">// End batch drawing mode and refreshes the undisplayed drawing</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">EndBatchDraw</span><span class="hljs-params">(<span class="hljs-type">int</span> left, <span class="hljs-type">int</span> top, <span class="hljs-type">int</span> right, <span class="hljs-type">int</span> bottom)</span></span>;    <span class="hljs-comment">// End batch drawing mode and refreshes the undisplayed drawing</span><br></code></pre></td></tr></table></figure><p>哦怎么又变成 big camel case 了。作者同志终于想起来世界上居然还有断句这种东西了。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">InputBox</span><span class="hljs-params">(LPTSTR pString, <span class="hljs-type">int</span> nMaxCount, LPCTSTR pPrompt = <span class="hljs-literal">NULL</span>, LPCTSTR pTitle = <span class="hljs-literal">NULL</span>, LPCTSTR pDefault = <span class="hljs-literal">NULL</span>, <span class="hljs-type">int</span> width = <span class="hljs-number">0</span>, <span class="hljs-type">int</span> height = <span class="hljs-number">0</span>, <span class="hljs-type">bool</span> bOnlyOK = <span class="hljs-literal">true</span>)</span></span>;<br></code></pre></td></tr></table></figure><p>然后参数也从之前的乱来风格（一会匈牙利一会作者最爱的不断句魔改版匈牙利）改成匈牙利了。不禁令人好奇他到底想要干什么。</p><p>有人说，这不是尬黑吗？至少人家一个系列的 API ——一个 API 族——内部风格是统一的！你这属于是找些莫名其妙的借口抹黑我们 EasyX。还给你搞上 family 了！咱们 Vulkan 分功能有 Queue family，EasyX 分功能有 API family，一个 family 里面的东西才是 consistent 的，不是一个 family 就不保证各方面的 consistency，非常高级，接轨国际！好嘛……</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// Image related functions</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">loadimage</span><span class="hljs-params">(IMAGE *pDstImg, LPCTSTR pImgFile, <span class="hljs-type">int</span> nWidth = <span class="hljs-number">0</span>, <span class="hljs-type">int</span> nHeight = <span class="hljs-number">0</span>, <span class="hljs-type">bool</span> bResize = <span class="hljs-literal">false</span>)</span></span>;                    <span class="hljs-comment">// Load image from a file (bmp/gif/jpg/png/tif/emf/wmf/ico)</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">loadimage</span><span class="hljs-params">(IMAGE *pDstImg, LPCTSTR pResType, LPCTSTR pResName, <span class="hljs-type">int</span> nWidth = <span class="hljs-number">0</span>, <span class="hljs-type">int</span> nHeight = <span class="hljs-number">0</span>, <span class="hljs-type">bool</span> bResize = <span class="hljs-literal">false</span>)</span></span>;    <span class="hljs-comment">// Load image from resources (bmp/gif/jpg/png/tif/emf/wmf/ico)</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">saveimage</span><span class="hljs-params">(LPCTSTR pImgFile, IMAGE* pImg = <span class="hljs-literal">NULL</span>)</span></span>;                                                                        <span class="hljs-comment">// Save image to a file (bmp/gif/jpg/png/tif)</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">getimage</span><span class="hljs-params">(IMAGE *pDstImg, <span class="hljs-type">int</span> srcX, <span class="hljs-type">int</span> srcY, <span class="hljs-type">int</span> srcWidth, <span class="hljs-type">int</span> srcHeight)</span></span>;                                                <span class="hljs-comment">// Get image from device</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">putimage</span><span class="hljs-params">(<span class="hljs-type">int</span> dstX, <span class="hljs-type">int</span> dstY, <span class="hljs-type">const</span> IMAGE *pSrcImg, DWORD dwRop = SRCCOPY)</span></span>;                                                <span class="hljs-comment">// Put image to device</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">putimage</span><span class="hljs-params">(<span class="hljs-type">int</span> dstX, <span class="hljs-type">int</span> dstY, <span class="hljs-type">int</span> dstWidth, <span class="hljs-type">int</span> dstHeight, <span class="hljs-type">const</span> IMAGE *pSrcImg, <span class="hljs-type">int</span> srcX, <span class="hljs-type">int</span> srcY, DWORD dwRop = SRCCOPY)</span></span>;        <span class="hljs-comment">// Put image to device</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">rotateimage</span><span class="hljs-params">(IMAGE *dstimg, IMAGE *srcimg, <span class="hljs-type">double</span> radian, COLORREF bkcolor = BLACK, <span class="hljs-type">bool</span> autosize = <span class="hljs-literal">false</span>, <span class="hljs-type">bool</span> highquality = <span class="hljs-literal">true</span>)</span></span>;<span class="hljs-comment">// Rotate image</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Resize</span><span class="hljs-params">(IMAGE* pImg, <span class="hljs-type">int</span> width, <span class="hljs-type">int</span> height)</span></span>;    <span class="hljs-comment">// Resize the device</span><br><span class="hljs-function">DWORD* <span class="hljs-title">GetImageBuffer</span><span class="hljs-params">(IMAGE* pImg = <span class="hljs-literal">NULL</span>)</span></span>;            <span class="hljs-comment">// Get the display buffer of the graphics device</span><br><span class="hljs-function">IMAGE* <span class="hljs-title">GetWorkingImage</span><span class="hljs-params">()</span></span>;                            <span class="hljs-comment">// Get current graphics device</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">SetWorkingImage</span><span class="hljs-params">(IMAGE* pImg = <span class="hljs-literal">NULL</span>)</span></span>;            <span class="hljs-comment">// Set current graphics device</span><br><span class="hljs-function">HDC <span class="hljs-title">GetImageHDC</span><span class="hljs-params">(IMAGE* pImg = <span class="hljs-literal">NULL</span>)</span></span>;                <span class="hljs-comment">// Get the graphics device handle</span><br></code></pre></td></tr></table></figure><p><strong>请问这是什么意思？</strong></p><p>一个图形变换能给我整出两套不一样的命名法来，这个作者确实是有水平的。他自己写下面那行的时候能不能看一下自己之前写的啥？</p><p>然后有人又要说了，EasyX 是大项目，要保证 API 的前向兼容性……你能不能把旧的函数用宏或者随便什么东西设成新函数的别名，然后加一个 deprecation warning，相信 EasyX 的作者是做了这个功能的了吧。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">if</span> _MSC_VER &gt; 1200 &amp;&amp; _MSC_VER &lt; 1900</span><br>    <span class="hljs-meta">#<span class="hljs-keyword">define</span> _EASYX_DEPRECATE                    __declspec(deprecated(<span class="hljs-string">&quot;This function is deprecated.&quot;</span>))</span><br>    <span class="hljs-meta">#<span class="hljs-keyword">define</span> _EASYX_DEPRECATE_WITHNEW(_NewFunc)    __declspec(deprecated(<span class="hljs-string">&quot;This function is deprecated. Instead, use this new function: &quot;</span> #_NewFunc <span class="hljs-string">&quot;. See https://docs.easyx.cn/&quot;</span> #_NewFunc <span class="hljs-string">&quot; for details.&quot;</span>))</span><br>    <span class="hljs-meta">#<span class="hljs-keyword">define</span> _EASYX_DEPRECATE_OVERLOAD(_Func)    __declspec(deprecated(<span class="hljs-string">&quot;This overload is deprecated. See https://docs.easyx.cn/&quot;</span> #_Func <span class="hljs-string">&quot; for details.&quot;</span>))</span><br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br>    <span class="hljs-meta">#<span class="hljs-keyword">define</span> _EASYX_DEPRECATE</span><br>    <span class="hljs-meta">#<span class="hljs-keyword">define</span> _EASYX_DEPRECATE_WITHNEW(_NewFunc)</span><br>    <span class="hljs-meta">#<span class="hljs-keyword">define</span> _EASYX_DEPRECATE_OVERLOAD(_Func)</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure><p>好消息，做了；坏消息，这个功能是 MSVC exclusive 的。</p><p>但是众所周知有一个东西叫做 <code>[[deprecated]]</code> 注解。<strong>莫非你 EasyX 用的就是个古董 C++ 然后一点现代特性都没有吗？那你用 C++ 的意义在哪里啊？</strong></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> __cplusplus</span><br><span class="hljs-meta">#<span class="hljs-keyword">error</span> EasyX is only for C++</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure><p>哦，原来用了类啊。<strong>但是对那几个类的操作为什么不是调用方法而是给某些函数传指针啊？我到底写的是 C++ 还是 C 啊我请问了？为什么不直接用 C 写呢？</strong></p><p>再来看看这个。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">int</span>  <span class="hljs-title">getrop2</span><span class="hljs-params">()</span></span>;                        <span class="hljs-comment">// Get binary raster operation mode</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">setrop2</span><span class="hljs-params">(<span class="hljs-type">int</span> mode)</span></span>;                <span class="hljs-comment">// Set binary raster operation mode</span><br><span class="hljs-function"><span class="hljs-type">int</span>  <span class="hljs-title">getpolyfillmode</span><span class="hljs-params">()</span></span>;                <span class="hljs-comment">// Get polygon fill mode</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">setpolyfillmode</span><span class="hljs-params">(<span class="hljs-type">int</span> mode)</span></span>;        <span class="hljs-comment">// Set polygon fill mode</span><br></code></pre></td></tr></table></figure><p>当时我和我室友看着这几个 <code>mode</code>s out of nowhere 感到无比的迷惑。然后我才反应过来这几个地方是要填 GDI 里面那些常量的。比如前两个就是选择黑&#x2F;白&#x2F;覆盖&#x2F;按位和&#x2F;按位异或&#x2F;按位取反那些的，其实就是封装的 <code>GetROP2</code> 和 <code>SetROP2</code> 两个函数。</p><p><strong>把这里要填哪些值、能填哪些值写出来真的很难吗？</strong></p><p><strong>写个意思清晰点的类型别名很难吗？</strong></p><p>写一个案例，比如</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// Raster operation mode.</span><br><span class="hljs-comment">// ...</span><br><span class="hljs-comment">// R2_BLACK    : ...</span><br><span class="hljs-comment">// R2_COPYPEN  : ...</span><br><span class="hljs-comment">// ...</span><br><span class="hljs-comment">// See also: https://learn.microsoft.com/...</span><br><span class="hljs-keyword">typedef</span> <span class="hljs-type">int</span> RasterOperationMode;<br><br><span class="hljs-comment">// Get binary raster operation mode</span><br><span class="hljs-function">RasterOperationMode <span class="hljs-title">getrop2</span><span class="hljs-params">()</span></span>;<br><span class="hljs-comment">// Set binary raster operation mode</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">setrop2</span><span class="hljs-params">(RasterOperationMode nMode)</span></span>;<br></code></pre></td></tr></table></figure><p>其实我觉得他要真用 C++ 就应该把这些玩意都给包装成 enum class，或者至少包装成个 enum 然后内部去处理 GDI 那些事情。然后他偏不，非要把这些玩意统统给你用户处理，至于用户怎么难受就不是他的问题了。</p><p>另外一个典型例子是这个消息封装。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// Message Structure</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">ExMessage</span><br>&#123;<br>    USHORT message;                    <span class="hljs-comment">// The message identifier</span><br>    <span class="hljs-keyword">union</span><br>    &#123;<br>        <span class="hljs-comment">// Data of the mouse message</span><br>        <span class="hljs-keyword">struct</span><br>        &#123;<br>            <span class="hljs-type">bool</span> ctrl        :<span class="hljs-number">1</span>;        <span class="hljs-comment">// Indicates whether the CTRL key is pressed</span><br>            <span class="hljs-type">bool</span> shift        :<span class="hljs-number">1</span>;        <span class="hljs-comment">// Indicates whether the SHIFT key is pressed</span><br>            <span class="hljs-type">bool</span> lbutton    :<span class="hljs-number">1</span>;        <span class="hljs-comment">// Indicates whether the left mouse button is pressed</span><br>            <span class="hljs-type">bool</span> mbutton    :<span class="hljs-number">1</span>;        <span class="hljs-comment">// Indicates whether the middle mouse button is pressed</span><br>            <span class="hljs-type">bool</span> rbutton    :<span class="hljs-number">1</span>;        <span class="hljs-comment">// Indicates whether the right mouse button is pressed</span><br>            <span class="hljs-type">short</span> x;                <span class="hljs-comment">// The x-coordinate of the cursor</span><br>            <span class="hljs-type">short</span> y;                <span class="hljs-comment">// The y-coordinate of the cursor</span><br>            <span class="hljs-type">short</span> wheel;            <span class="hljs-comment">// The distance the wheel is rotated, expressed in multiples or divisions of 120</span><br>        &#125;;<br><br>        <span class="hljs-comment">// Data of the key message</span><br>        <span class="hljs-keyword">struct</span><br>        &#123;<br>            BYTE vkcode;            <span class="hljs-comment">// The virtual-key code of the key</span><br>            BYTE scancode;            <span class="hljs-comment">// The scan code of the key. The value depends on the OEM</span><br>            <span class="hljs-type">bool</span> extended    :<span class="hljs-number">1</span>;        <span class="hljs-comment">// Indicates whether the key is an extended key, such as a function key or a key on the numeric keypad. The value is true if the key is an extended key; otherwise, it is false.</span><br>            <span class="hljs-type">bool</span> prevdown    :<span class="hljs-number">1</span>;        <span class="hljs-comment">// Indicates whether the key is previously up or down</span><br>        &#125;;<br><br>        <span class="hljs-comment">// Data of the char message</span><br>        TCHAR ch;<br><br>        <span class="hljs-comment">// Data of the window message</span><br>        <span class="hljs-keyword">struct</span><br>        &#123;<br>            WPARAM wParam;<br>            LPARAM lParam;<br>        &#125;;<br>    &#125;;<br>&#125;;<br></code></pre></td></tr></table></figure><p>好吧，关于这个 union 的安全性问题。他也不整一个枚举来区分消息类型，反正你自己去用 <code>WM_*</code> 那些值判断吧，有些字段可能初始化了有些字段没初始化，哪些能用哪些不能用我也不告诉你，你 UB 关我屁事，自己动脑子想想，能跑就行。</p><p>还有那个虚拟键码和键盘扫描码。你猜猜刚入门的同学听得懂你在这里叽叽咕咕的那些东西不？同样是一个 u8 丢在那里就跑了。连个预处理都不肯做。简直懒的令人发指。</p><p>还是那句话：<strong>封装了约等于没有封装，简化了约等于没简化</strong>。</p><p>别的什么诸如滥用全局状态，什么错误处理约等于没有之类的问题我真不想说了。基本的问题都解决不了，还指望这个作者能干什么呢。</p><p>可能这就是大佬吧，我的境界不够高，洞见不了他深邃的超凡脱俗的设计思想。</p><p>说实话我这段时间学 Vulkan API 的时候看那些东西都没有看 EasyX 那么难受。Vulkan 只是单纯的东西多而杂，不是烂，该有的设计规范人家一点不缺。</p><h3 id="作者垃圾的运营能力"><a href="#作者垃圾的运营能力" class="headerlink" title="作者垃圾的运营能力"></a>作者垃圾的运营能力</h3><p><strong>事情是不管的，惨是不哭不行的。代码是不放出来的，钱也是不赚的。问题是不修的，先把书卖出去就行。</strong></p><p>我很好奇什么时候他能让大家 build from source。也不知道他抱着这个破烂的代码不放只提供静态库是准备待价而沽还是怎么的。谁去找他买这个玩意谁简直瞎了眼了。</p><h3 id="其它"><a href="#其它" class="headerlink" title="其它"></a>其它</h3><p>非常不利于学生进行图形学入门。也不利于 C++ 学习。</p><p>学完以后几乎获得不了任何有用的知识和设计经验。对于图形学原理的理解还是一坨浆糊。</p><p><img src="/img/post/2025-06/01/01.jpg"></p><h2 id="结语：感觉不如"><a href="#结语：感觉不如" class="headerlink" title="结语：感觉不如"></a>结语：感觉不如</h2><p><strong>感觉不如 SFML。</strong></p><p>个人认为 SFML 是一个非常优秀的入门级图形库。门槛很低，入门很简单。但上限也很高，可以接 ImGUI，可以接 Spine 做小人动画，可以写 GLSL 做花里胡哨的效果。学下来也会对图形学里面的一些基本概念有一个认知。API 设计也非常现代。</p><p>找一个最基本的功能来和 EasyX 比较一下。这是 SFML 的事件处理：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">while</span> (<span class="hljs-keyword">auto</span> event = window-&gt;<span class="hljs-built_in">pollEvent</span>()) &#123;<br>    <span class="hljs-keyword">if</span> (event.<span class="hljs-built_in">has_value</span>()) &#123;<br>        <span class="hljs-keyword">if</span> (event-&gt;<span class="hljs-built_in">is</span>&lt;sf::Event::Closed&gt;()) &#123;<br>            window-&gt;<span class="hljs-built_in">close</span>();<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (event-&gt;<span class="hljs-built_in">is</span>&lt;sf::Event::KeyPressed&gt;()) &#123;<br>            sf::KeyBoard::Key keyCode = event-&gt;<span class="hljs-built_in">getIf</span>&lt;sf::Event::KeyPressed&gt;()-&gt;code;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>std::optional</code> 一个可空，有事件就是非空，没有就是 <code>std::nullopt</code> 非常安全，而且显式。然后 <code>Event::is()</code> 内部是用模板元编程整的一个判断，如果判断成功了就返回变体类型 <code>std::holds_alternative</code> 的结果。 <code>getIf</code> 也是一个道理。非常现代，非常美观。<code>KeyBoard::Key</code> 是一个枚举类，里面哪个键是哪个映射的清清楚楚。</p><p>这不比 EasyX 强太多了。</p><p>我的建议是以后把 EasyX 踢到历史垃圾堆里面算了。反正我已经找到细糠吃了，EasyX 谁爱用谁用。这玩意我自己光看着都难受。</p><p><img src="/img/post/2025-06/01/02.png"></p>]]></content>
    
    
    
    <tags>
      
      <tag>C++</tag>
      
      <tag>图形学</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>赛后反思</title>
    <link href="/2025/06/29/%E8%B5%9B%E5%90%8E%E5%8F%8D%E6%80%9D/"/>
    <url>/2025/06/29/%E8%B5%9B%E5%90%8E%E5%8F%8D%E6%80%9D/</url>
    
    <content type="html"><![CDATA[<p>给我的感觉就是世界是一个巨大的写死，在那个文档写的不明不白不清不楚的平台上整半天视觉还不如写死来的直接。之后给小登培训的时候也要教他们写死，大家一起写死，大家一起摆烂，大家一起得奖，大家一起加综测，大家一起永垂不朽。</p>]]></content>
    
    
    
    <tags>
      
      <tag>日常</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>在 C++ 中实现反射的一种简易方案</title>
    <link href="/2025/03/19/%E5%9C%A8-C-%E4%B8%AD%E5%AE%9E%E7%8E%B0%E5%8F%8D%E5%B0%84%E7%9A%84%E4%B8%80%E7%A7%8D%E7%AE%80%E6%98%93%E6%96%B9%E6%A1%88/"/>
    <url>/2025/03/19/%E5%9C%A8-C-%E4%B8%AD%E5%AE%9E%E7%8E%B0%E5%8F%8D%E5%B0%84%E7%9A%84%E4%B8%80%E7%A7%8D%E7%AE%80%E6%98%93%E6%96%B9%E6%A1%88/</url>
    
    <content type="html"><![CDATA[<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>众所周知，C++并没有像许多语言（例如 C# 或者 Java）那样的反射（Reflection）机制，也没有类似于 Rust 的所谓过程宏（Procedural Macro）来间接实现类似的效果。虽然说大部分场景并不会涉及到类似的需求，但是一旦涉及到就非常令人头大。在这些场景下，往往需要依赖工具提供的额外支持，或者极其复杂的宏机制来达到这样的效果，案例包括 Qt 中的反射和 GDExtension 的 GDOBJECT。</p><p>这里给出一种比较简单的、不依赖于额外工具的侵入式反射实现。</p><p>简略起见（其实是因为我只做了这些），这里主要介绍类的成员和方法的反射。</p><h2 id="对于类成员变量"><a href="#对于类成员变量" class="headerlink" title="对于类成员变量"></a>对于类成员变量</h2><p>这里主要讨论 <code>const MemberType</code> 和 <code>MemberType</code> 的普通的成员变量。<code>static MemberType</code> 不在讨论的范畴内。</p><p>对于 <code>ClassType</code> 类的 <code>member</code> 成员，我们可以通过 <code>&amp;ClassType::member</code> 来获得成员变量的指针，其类型为 <code>ClassType::MemberType*</code>。</p><p>我们可以使用一个自动推导类型模板参数（C++17 引入）传入这个指针。接着，用 <code>decltype()</code> 拿到他的类型。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">auto</span> Member&gt;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">register_member</span><span class="hljs-params">(<span class="hljs-type">const</span> string&amp; name)</span> </span>&#123;<br>    <span class="hljs-keyword">using</span> MemberTypeFull = <span class="hljs-keyword">decltype</span>(Member);<br>&#125;<br></code></pre></td></tr></table></figure><p>累了先不写了，改天续上。</p>]]></content>
    
    
    
    <tags>
      
      <tag>C++</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>2025 年初 揭阳-潮州-汕头纪行</title>
    <link href="/2025/02/22/2025-%E5%B9%B4%E5%88%9D-%E6%8F%AD%E9%98%B3-%E6%BD%AE%E5%B7%9E-%E6%B1%95%E5%A4%B4%E7%BA%AA%E8%A1%8C/"/>
    <url>/2025/02/22/2025-%E5%B9%B4%E5%88%9D-%E6%8F%AD%E9%98%B3-%E6%BD%AE%E5%B7%9E-%E6%B1%95%E5%A4%B4%E7%BA%AA%E8%A1%8C/</url>
    
    <content type="html"><![CDATA[<h2 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h2><p>当时寒假前本来是准备假期做点正事的，但是真的放假以后，反而没啥心情去干正事了，每天不是爽食就是上网，可以说是饱食终日无所用心了。然后年后正好有这么一个契机出去耍耍，觉得没必要再拿《CSAPP》没看完之类的奇葩理由（就那个精神状况给我两个寒假都磨叽不完）搪塞了，所以直接就去了。现在正好有点时间，把照片整理一下，虽然说也没拍啥。</p><h2 id="出发"><a href="#出发" class="headerlink" title="出发"></a>出发</h2><p>从绵阳机场飞揭阳的飞机，上午的。说起来之前绵阳修机场的时候有人非常反对，觉得大而无当，一直骂；现在机场发挥作用了，又开始夸当初修机场那家伙有先见之明了。然而很显然的事实就是，修机场那家伙肯定不是高瞻远瞩，然后先验地知道绵阳未来十几年会有这种需求——其本质一言以蔽之，纯粹就是吃饱了撑的。本意是不好的——但是现在给执行好了。</p><p>刚起飞的时候没有看见绵中。不过看不看都无所谓。很奇怪，离开高中以后，我是没有多么浓烈的 nostalgia 的，倒是偶尔会成为噩梦素材。不念旧这点不知道是不是好事。不过尽量向前看肯定不是坏事。</p><p>飞了两个半小时，就差不多到揭阳上面了。</p><p><img src="/img/post/2025-02/01/01.jpg" alt="img" title="榕江，远处的桥梁系榕江大桥。"></p><p>说起来揭阳这个机场的格局也挺有意思：它大概处在揭阳-潮州-汕头三座城市构成的类等边三角形的中心。所以说叫“揭阳潮汕”机场倒也合理，四个字把三个地方都囊括了。</p><h2 id="揭阳-day1"><a href="#揭阳-day1" class="headerlink" title="揭阳 day1"></a>揭阳 day1</h2><p>落地以后租了辆车就往市区住的地方开。</p><p>当晚去了骑楼街（高德上全称“揭阳古城中山骑楼街”），开车去的路上人都给我开麻了，全是车，一路堵过去的——不过过年嘛，也正常。最后把车停在了某个神必的犄角旮旯里，旁边还有个渡口，人员渡河只要几块钱。</p><p><img src="/img/post/2025-02/01/02.jpg" alt="img" title="渡口"></p><p>骑楼街里面整的挺花哨，有卖本地产的吃的。当然这地方也未能免俗——还是有人卖古镇经典特产之牛皮糖。不过似乎没有另一个古镇经典特产——音像店。</p><p><img src="/img/post/2025-02/01/03.jpg" alt=" "></p><p><img src="/img/post/2025-02/01/04.jpg" alt=" "></p><p>顺便去骑楼街旁边的揭阳学宫看了一眼。城隍庙就没去了。</p><p><img src="/img/post/2025-02/01/05.jpg" alt="img" title="揭阳学宫门口的照壁"></p><p><img src="/img/post/2025-02/01/06.jpg" alt="img" title="揭阳学宫本体，到的时候已经关门了，这是把手从栅栏缝伸进去拍的"></p><p>从骑楼街出来买了份鹅吃。白味的，要沾沾水吃。总的来说味道不错，但是没拍照片。</p><h2 id="揭阳-day2"><a href="#揭阳-day2" class="headerlink" title="揭阳 day2"></a>揭阳 day2</h2><p>上午去揭阳忘了哪个地方（导航里面数据谜之失踪了）看当地庆祝活动。有英歌舞看，但是不知道为什么没拍下来。</p><p>看完以后去一个牛肉火锅店吃了午饭。人气还是相当火爆的。据说楼上楼下有一百桌，不知道是不是有夸大的成分在。另外不得不说那家店任务调度是真厉害，接待效率相当可以，去了不用等位置，很快就能吃上。</p><p>牛肉和锅没有拍，拍了个牛肉菠萝包。不知道是自己构建的还是 pre-built 的，但尝起来还算不赖。</p><p><img src="/img/post/2025-02/01/07.jpg" alt="img" title="菠萝包，相当扎实的一个"></p><p>吃完饭就往阳美走。</p><p>阳美据说是因为做玉石生意，整个村子都很有钱。——实际上，乍一看，这个村子已经像个小县城一样了。</p><p>又找了个犄角旮旯把车停那里了。</p><p>下午到的时候，阳美那里正好也是有英歌舞。不过阳美这边还有另外两个活动：一是看人家放炮仗，二是有个所谓“火把节”。</p><p>炮仗乒乒乓乓地从 7 点一直放到 9 点，阵仗看着有点吓人，不得不说是真的烧钱……</p><p><img src="/img/post/2025-02/01/08.jpg" alt=" "></p><p><img src="/img/post/2025-02/01/09.jpg" alt=" "></p><p>然后就是火把节。</p><p><img src="/img/post/2025-02/01/10.jpg" alt=" "></p><p>用的是煤油作燃料，味道不是一般的熏，洗了老半天才洗掉。</p><p>晚上回去洗头一股烟硝味。我还算离得远的了，难以想象凑跟前看的人能被熏成什么样子。</p><h2 id="汕头-day3"><a href="#汕头-day3" class="headerlink" title="汕头 day3"></a>汕头 day3</h2><p>忘了哪里了，似乎是凤岗？</p><p><img src="/img/post/2025-02/01/11.jpg" alt=" " title="注意看画面中央扛标旗的女生的花篮：初音未来"></p><p>不得不说这个场面还是有点意思的。前现代性和后现代性在这一刻达成了某种奇异的……共谋？总之还是挺神奇的。——另外，据说十年前扛标旗的“MM”们还是杀马特造型呢，相比之下现在的这种其实已经很温和了……</p><p>到了汕头市区吃了个肠粉，店门口还贴个了隋坡师傅的大照片。我是喜欢看他的号，也就是那个“特厨隋卞”上面发的视频的，内容比较有意思。（我是不是有诉诸权威的嫌疑？）</p><p><img src="/img/post/2025-02/01/12.jpg" alt=" " title="肠粉"></p><p>味道还可以。回瓜大之后，在海天苑美食广场也吃了肠粉，我说真不如广东的（是不是过分苛责你瓜的厨师师傅了？）你瓜也有个所谓煲仔饭，但是一点不香，充其量只能算盖浇饭换了个小锅装着。</p><p><img src="/img/post/2025-02/01/13.jpg" alt=" " title="汕头海湾大桥"></p><p>然后去小公园，实际上是个仿古建筑群。车停在附近的体育馆的地下车库，收费非常便宜，而且没啥人停。</p><p>小公园中间有个亭子，如图所示。</p><p><img src="/img/post/2025-02/01/14.jpg" alt=" " title="画面右侧的就是。另外不知道谁的奶龙气球飘在空中"></p><p>我去的时候人还不算多，旁边买了杯瑞幸还能坐那里喝一会。后两天去的人才是真的爽，看照片上面人挤人——要我说，挤的跟豆豉鲮鱼罐头里面的鱼一样，有什么去的必要嘛……</p><p><img src="/img/post/2025-02/01/15.jpg" alt=" "></p><p><img src="/img/post/2025-02/01/16.jpg" alt=" " title="汕头旅社"></p><p>然后走之前去看了一眼汕头旅社。这个地方更是网红打卡典中点，拥塞了一堆人在那里摆各种花里胡哨的 pose 拍照。另外当时衣服没穿够，感觉有点冷了，远远的拍了张就撤了。</p><p><img src="/img/post/2025-02/01/17.jpg" alt=" " title="仍然是海湾大桥"></p><p>当晚吃了只沙姜鸡，总体来说不错。</p><h2 id="汕头-day4"><a href="#汕头-day4" class="headerlink" title="汕头 day4"></a>汕头 day4</h2><p>在汕头周边瞎逛。</p><p>有个什么庙。但是庙我没有拍，拍了旁边建在海边的火电厂。</p><p><img src="/img/post/2025-02/01/18.jpg" alt=" " title="火电厂的烟囱"></p><p>下面这个不知道是火电厂的什么建筑。</p><p><img src="/img/post/2025-02/01/19.jpg" alt=" "></p><p>不禁让我想起某部早期无厘头喜剧电影 <em>The Naked Gun</em> 里面的一个段子。</p><p><img src="/img/post/2025-02/01/20.jpg" alt=" "></p><p>中午在旁边渔村吃了个海鲜大排档，价格比较公道，分量还算实在。</p><p>本来准备下午就往南澳岛上走的，无奈上岛方向大排长龙，想了想还是再等一会吧。</p><p>先去石炮台公园转了几圈。没有拍照。</p><p>晚饭随便对付了一下，然后往岛上去。过桥费往返需要接近一百块钱。</p><p><img src="/img/post/2025-02/01/21.jpg" alt=" " title="南澳大桥"></p><p><img src="/img/post/2025-02/01/22.jpg" alt=" " title="南澳岛上面一个小的灯塔，景点作用应该高于实用作用"></p><h2 id="南澳-day5"><a href="#南澳-day5" class="headerlink" title="南澳 day5"></a>南澳 day5</h2><p>围着岛开了一圈。感觉可看的东西比较有限。</p><p><img src="/img/post/2025-02/01/23.jpg" alt=" " title="“北回归线标记”"></p><p>嗯……主要是打卡意义。其实这附近不好看。同时还有个卖烤串的摊子一直用奇响无比的声音播放劲爆音乐，就算景色漂亮也很难有啥心情吧……</p><p><img src="/img/post/2025-02/01/24.jpg" alt=" " title="“彩虹海”"></p><p>这个景点有点意味不明。我最早以为彩虹海是水里面长了藻类之类的导致水体颜色不一，后来才知道所谓彩虹海就是养生蚝的彩色浮筒……</p><p>到底是什么人起的这么些稀奇古怪的名字？</p><p>当晚到了潮州，远远的拍了张牌坊街的照片。这个角度是一个居民楼的顶部，上去的人太多，住家直接摆了个凳子在那里，收想要上天台的游客的小费，非常好玩。</p><p><img src="/img/post/2025-02/01/25.jpg" alt=" " title="牌坊街远景"></p><p>当然我设备不好，拍出来效果很一般。</p><h2 id="潮州-day6"><a href="#潮州-day6" class="headerlink" title="潮州 day6"></a>潮州 day6</h2><p>第二天早上去看广济桥。</p><p>广济桥是个浮桥，晚上拆掉供大型船只过，白天再合上供行人过。不过现在更多是一种表演性质的仪式了。</p><p><img src="/img/post/2025-02/01/26.jpg" alt=" " title="广济桥（未合拢状态）"></p><p>本来说的是九点开始合桥，结果不知道和春节假期有没有关系，拖到了十点半，结束更是等到十一点去了。正好把旁边的下水门城楼和牌坊街（昨天没有进去）逛了。</p><p><img src="/img/post/2025-02/01/27.jpg" alt=" "></p><p>牌坊街商业化程度有点高，给我的感觉一般。</p><p>当晚去看了烧火龙。烧火龙之前先要烧鱼和凤凰。有不明真相的游客把鱼当作火龙，看完鱼也不问一下就急匆匆的跑了，这真是……</p><p><img src="/img/post/2025-02/01/28.jpg" alt=" "></p><p><img src="/img/post/2025-02/01/29.jpg" alt=" " title="图中即为“火龙”"></p><h2 id="返程"><a href="#返程" class="headerlink" title="返程"></a>返程</h2><p>当天早上开去德安里逛了一圈。当地修了个小博物馆，不要门票，里面放了一些稀奇古怪的文物。展厅光线有点欠佳，但总的来说诚意是有的。</p><p>买了份米肠吃。</p><p>然后直接开到机场去，还车，回家。（是否结束的过于草率了？）</p><p><img src="/img/post/2025-02/01/30.jpg" alt=" "></p>]]></content>
    
    
    
    <tags>
      
      <tag>日常</tag>
      
      <tag>游记</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>人麻了</title>
    <link href="/2025/02/21/%E4%BA%BA%E9%BA%BB%E4%BA%86/"/>
    <url>/2025/02/21/%E4%BA%BA%E9%BA%BB%E4%BA%86/</url>
    
    <content type="html"><![CDATA[<p>配这个 GDExtension 给我整麻了，Windows Build 默认使用 Windows 那套 API 进行动态库加载，然后我这个 MinGW 编译的不知为何就完全用不了。这事情之前就有人提过不知道为何没有解决。总之给我整道心破碎了，就这样吧。</p>]]></content>
    
    
    
    <tags>
      
      <tag>日常</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Godot Extension 开发环境配置踩坑</title>
    <link href="/2025/02/21/Godot-Extension-%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%E8%B8%A9%E5%9D%91/"/>
    <url>/2025/02/21/Godot-Extension-%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%E8%B8%A9%E5%9D%91/</url>
    
    <content type="html"><![CDATA[<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>上一篇文章介绍了我配置 ffmpeg 开发环境的过程。这篇文章介绍配置 Godot Extension （GDExtension）开发环境过程中踩的一些坑。</p><p>众所周知，Godot 引擎在 4.x 大版本伊始就将旧的 GDNative 插件系统更换为了更先进（大约）的GDExtension 系统。其开发团队希望这套新系统是向后兼容的，然而不幸的是因为种种原因，minor version 0 和 1 之间就不兼容了。不过这不是今天介绍的重点。</p><p>我现在正在使用 Godot 4.2，开发环境为 Clion。</p><h2 id="怎么构建静态库？"><a href="#怎么构建静态库？" class="headerlink" title="怎么构建静态库？"></a>怎么构建静态库？</h2><h3 id="官方"><a href="#官方" class="headerlink" title="官方"></a>官方</h3><p>对于构建开发 GDExtension 所需的 godot-cpp 库，官方给出的说法是使用 scons 构建系统，并且附上了相应的脚本。实际上如果你平时使用过这个，当然可以按照官方的说法搞。但我平时不用这个。另外比较坑的一点是这个脚本不会输出它使用的编译器，导致开始我编译静态库用的是 MSVC，弄到 Clion 那边编译插件动态库时候用的 MinGW，然后一直链接失败……所以说还是要注意一下。</p><h3 id="CMake"><a href="#CMake" class="headerlink" title="CMake"></a>CMake</h3><p>官方也给出了使用 CMake 构建的方案。该怎么编译怎么编译就是了。</p><h2 id="怎么写-CMakeList？"><a href="#怎么写-CMakeList？" class="headerlink" title="怎么写 CMakeList？"></a>怎么写 CMakeList？</h2><p>因为我用的 Clion，然后构建系统用的 CMake，所以说这上面要花点工夫。官方的样例代码 <code>godot-cpp/test</code> 里面有一个 CMakeList，可以作为参考。</p><p>我的项目架构如下：</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs text">/src<br>/thirdparty<br>├─godot_cpp<br>│  ├─bin # static lib<br>│  ├─gd_extension<br>│  │  └─gdextension_interface.h<br>│  ├─gen<br>│  │  ├─include<br>│  │  │  └─godot_cpp<br>│  │  │      ├─classes<br>│  │  │      ├─core<br>│  │  │      └─variant<br>│  │  └─src<br>│  │      ├─classes<br>│  │      └─variant<br>│  └─include<br>│      └─godot_cpp<br>│          ├─classes<br>│          ├─core<br>│          ├─templates<br>│          └─variant<br>└─libavx # ffmpeg<br>    ├─bin<br>    ├─include<br>    │  ├─libavcodec<br>    │  ├─libavdevice<br>    │  ├─libavfilter<br>    │  ├─libavformat<br>    │  ├─libavutil<br>    │  ├─libpostproc<br>    │  ├─libswresample<br>    │  └─libswscale<br>    └─lib<br>        └─pkgconfig<br></code></pre></td></tr></table></figure><p>注意 <code>godot-cpp/include</code> <code>godot-cpp/gen/include</code> <code>godot-cpp/gd_extension</code> 里面的头文件都要导入！</p><p>并且最后还需要链接刚刚编译好的静态库。</p><p>我的 CMakeList 如下：</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><code class="hljs cmake"><span class="hljs-keyword">cmake_minimum_required</span>(VERSION <span class="hljs-number">3.29</span>)<br><span class="hljs-keyword">project</span>(godot_ffmpeg)<br><br><span class="hljs-keyword">set</span>(CMAKE_CXX_STANDARD <span class="hljs-number">17</span>)<br><span class="hljs-keyword">set</span>(CMAKE_CXX_STANDARD_REQUIRED <span class="hljs-keyword">ON</span>)<br><span class="hljs-keyword">set</span>(CMAKE_CXX_EXTENSIONS <span class="hljs-keyword">OFF</span>)<br><br><span class="hljs-keyword">set</span>(BUILD_AS_GODOT_EXTENSION <span class="hljs-keyword">ON</span>)<br><span class="hljs-keyword">set</span>(GODOT_EXTENSION_PLATFORM <span class="hljs-string">&quot;windows&quot;</span>)<br><span class="hljs-keyword">set</span>(GODOT_EXTENSION_TARGETED_BITS <span class="hljs-number">64</span>)<br><span class="hljs-keyword">set</span>(GODOT_EXTENSION_BUILD_TEMPLATE <span class="hljs-string">&quot;release&quot;</span>)<br><br><span class="hljs-keyword">file</span>(GLOB_RECURSE SOURCES <span class="hljs-string">&quot;$&#123;CMAKE_SOURCE_DIR&#125;/src/*.c**&quot;</span>)<br><span class="hljs-keyword">file</span>(GLOB_RECURSE HEADERS <span class="hljs-string">&quot;$&#123;CMAKE_SOURCE_DIR&#125;/src/*.h**&quot;</span>)<br><br><span class="hljs-keyword">include_directories</span>(<span class="hljs-variable">$&#123;CMAKE_SOURCE_DIR&#125;</span>/thirdparty/libavx/<span class="hljs-keyword">include</span>)<br><br><span class="hljs-keyword">link_directories</span>(<span class="hljs-variable">$&#123;CMAKE_SOURCE_DIR&#125;</span>/thirdparty/libavx/lib)<br><br><span class="hljs-keyword">if</span> (BUILD_AS_GODOT_EXTENSION)<br><br>    <span class="hljs-keyword">message</span>(STATUS <span class="hljs-string">&quot;Building as Godot extension.&quot;</span>)<br>    <span class="hljs-keyword">message</span>(STATUS <span class="hljs-string">&quot;Platform: $&#123;GODOT_EXTENSION_PLATFORM&#125;&quot;</span>)<br>    <span class="hljs-keyword">message</span>(STATUS <span class="hljs-string">&quot;Targeted bits: $&#123;GODOT_EXTENSION_TARGETED_BITS&#125;&quot;</span>)<br>    <span class="hljs-keyword">message</span>(STATUS <span class="hljs-string">&quot;Build template: $&#123;GODOT_EXTENSION_BUILD_TEMPLATE&#125;&quot;</span>)<br><br>    <span class="hljs-keyword">set</span>(GODOT_GDEXTENSION_DIR <span class="hljs-variable">$&#123;CMAKE_SOURCE_DIR&#125;</span>/thirdparty/godot_cpp/gd_extension)<br>    <span class="hljs-keyword">set</span>(CPP_BINDINGS_PATH <span class="hljs-variable">$&#123;CMAKE_SOURCE_DIR&#125;</span>/thirdparty/godot_cpp)<br>    <span class="hljs-keyword">set</span>(CPP_LIB_PATH <span class="hljs-variable">$&#123;CMAKE_SOURCE_DIR&#125;</span>/thirdparty/godot_cpp/bin)<br><br>    <span class="hljs-keyword">include_directories</span>(<span class="hljs-variable">$&#123;GODOT_GDEXTENSION_DIR&#125;</span>)<br>    <span class="hljs-keyword">include_directories</span>(<span class="hljs-variable">$&#123;CPP_BINDINGS_PATH&#125;</span>/<span class="hljs-keyword">include</span>)<br>    <span class="hljs-keyword">include_directories</span>(<span class="hljs-variable">$&#123;CPP_BINDINGS_PATH&#125;</span>/gen/<span class="hljs-keyword">include</span>)<br><br>    <span class="hljs-keyword">link_directories</span>(<span class="hljs-variable">$&#123;CMAKE_SOURCE_DIR&#125;</span>/thirdparty/godot_cpp/bin/)<br><br>    <span class="hljs-keyword">add_library</span>(godot_ffmpeg SHARED <span class="hljs-variable">$&#123;SOURCES&#125;</span> <span class="hljs-variable">$&#123;HEADERS&#125;</span>)<br><span class="hljs-keyword">else</span> ()<br><br>    <span class="hljs-keyword">message</span>(STATUS <span class="hljs-string">&quot;Building as standalone executable.&quot;</span>)<br>    <span class="hljs-keyword">add_executable</span>(godot_ffmpeg <span class="hljs-variable">$&#123;SOURCES&#125;</span> <span class="hljs-variable">$&#123;HEADERS&#125;</span>)<br><br><span class="hljs-keyword">endif</span> ()<br><br><span class="hljs-keyword">if</span> (BUILD_AS_GODOT_EXTENSION)<br><br>    <span class="hljs-keyword">target_include_directories</span>(<span class="hljs-variable">$&#123;PROJECT_NAME&#125;</span><br>            PRIVATE<br>                <span class="hljs-variable">$&#123;CPP_BINDINGS_PATH&#125;</span>/<span class="hljs-keyword">include</span><br>                <span class="hljs-variable">$&#123;CPP_BINDINGS_PATH&#125;</span>/gen/<span class="hljs-keyword">include</span><br>                <span class="hljs-variable">$&#123;GODOT_GDEXTENSION_DIR&#125;</span><br>    )<br><br><span class="hljs-keyword">endif</span> ()<br><br><span class="hljs-keyword">target_link_libraries</span>(<br>        godot_ffmpeg<br>        PRIVATE<br>        avcodec<br>        avdevice<br>        avfilter<br>        avformat<br>        avutil<br>        postproc<br>        swresample<br>        swscale<br>)<br><br><span class="hljs-keyword">if</span> (BUILD_AS_GODOT_EXTENSION)<br><br>    <span class="hljs-keyword">message</span>(STATUS <span class="hljs-string">&quot;Linking from: $&#123;CPP_LIB_PATH&#125;/libgodot-cpp.$&#123;GODOT_EXTENSION_PLATFORM&#125;.$&#123;GODOT_EXTENSION_BUILD_TEMPLATE&#125;.$&#123;GODOT_EXTENSION_TARGETED_BITS&#125;.a&quot;</span>)<br><br>    <span class="hljs-keyword">target_link_libraries</span>(godot_ffmpeg PRIVATE<br>            <span class="hljs-variable">$&#123;CPP_LIB_PATH&#125;</span>/libgodot-cpp.<span class="hljs-variable">$&#123;GODOT_EXTENSION_PLATFORM&#125;</span>.<span class="hljs-variable">$&#123;GODOT_EXTENSION_BUILD_TEMPLATE&#125;</span>.<span class="hljs-variable">$&#123;GODOT_EXTENSION_TARGETED_BITS&#125;</span>.a)<br><br><span class="hljs-keyword">endif</span> ()<br></code></pre></td></tr></table></figure><p>以上。</p>]]></content>
    
    
    
    <tags>
      
      <tag>C++</tag>
      
      <tag>Godot</tag>
      
      <tag>CMake</tag>
      
      <tag>游戏开发</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ffmpeg libav C++ 开发环境配置踩坑</title>
    <link href="/2025/02/20/ffmpeg-libav-C-%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%E8%B8%A9%E5%9D%91/"/>
    <url>/2025/02/20/ffmpeg-libav-C-%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%E8%B8%A9%E5%9D%91/</url>
    
    <content type="html"><![CDATA[<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>这段时间突发奇想，想要给 Godot 引擎的视频组件做一个 ffmpeg 的兼容层，整完这个就做 CS61B 的 lab 去了。今天晚上上完离散数学已经差不多九点了，以为配个环境应该要不了半小时，结果中间出各种问题，一直折腾到现在。现在把配置工作差不多做完了，顺便把踩的坑记录一下。</p><h2 id="几个关键问题"><a href="#几个关键问题" class="headerlink" title="几个关键问题"></a>几个关键问题</h2><h3 id="下载版本的选择"><a href="#下载版本的选择" class="headerlink" title="下载版本的选择"></a>下载版本的选择</h3><p>说实话 Windows 系统在这种时候就极其拉垮，开始下了全部源文件准备自己编译，结果 Windows 这边就出各种奇异搞笑问题。所以我的建议是，如果用 Windows 系统，最好还是去下预编译的版本吧……省事又省心。</p><p>一个预编译版本可在 <a href="https://www.ffmpeg.org/download.html">ffmpeg 官网</a> 找到。</p><p><img src="/img/post/2025-02/00/ffmpeg-site.png" alt="ffmpeg site download" title="红框中所示"></p><p>进入 Release 中下载 Windows 的包，解压缩。</p><h3 id="CMake-项目架构"><a href="#CMake-项目架构" class="headerlink" title="CMake 项目架构"></a>CMake 项目架构</h3><p>首先把 lib include 目录都放到正确的地方。例如我这里：</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs text">Project/<br>    thirdparty/<br>        libavx/<br>            include/<br>                libavcodec/<br>                    ...<br>                libavdevice/<br>                    ...<br>            lib/<br>                ...<br><br>    src/<br>        main.cpp<br></code></pre></td></tr></table></figure><p>然后 CMakeList.txt 文件我是这么写的：</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs cmake"><span class="hljs-keyword">cmake_minimum_required</span>(VERSION <span class="hljs-number">3.29</span>)<br><span class="hljs-keyword">project</span>(godot_ffmpeg)<br><br><span class="hljs-keyword">set</span>(CMAKE_CXX_STANDARD <span class="hljs-number">17</span>)<br><br><span class="hljs-keyword">include_directories</span>(thirdparty/libavx/<span class="hljs-keyword">include</span>)<br><span class="hljs-keyword">link_directories</span>(thirdparty/libavx/lib)<br><br><span class="hljs-keyword">add_executable</span>(godot_ffmpeg src/main.cpp)<br><br><span class="hljs-keyword">target_link_libraries</span>(<br>        godot_ffmpeg<br>        avcodec<br>        avdevice<br>        avfilter<br>        avformat<br>        avutil<br>        postproc<br>        swresample<br>        swscale<br>)<br></code></pre></td></tr></table></figure><p>这样 CMakeList 算是勉强配置好了。</p><h3 id="使用-C-调用-ffmpeg-函数"><a href="#使用-C-调用-ffmpeg-函数" class="headerlink" title="使用 C++ 调用 ffmpeg 函数"></a>使用 C++ 调用 ffmpeg 函数</h3><p>我这里创建的是一个 C++ 项目（因为 GDExtension 提供的是 C++ API）开始编译的时候报 <code>undefined reference to xxx</code>，这个解决起来简单，加个 <code>extern &quot;C&quot;</code> 的事情。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">extern</span> <span class="hljs-string">&quot;C&quot;</span> &#123;<br>    <span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;libavcodec/avcodec.h&gt;</span></span><br>    <span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;libavformat/avformat.h&gt;</span></span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="动态链接库"><a href="#动态链接库" class="headerlink" title="动态链接库"></a>动态链接库</h3><p>现在可以正常过编译了，但是运行时直接退出，返回 <code>-1073741515 (0xC0000135)</code>。这个是因为没有找到动态链接库导致的。把刚才下载的预编译包的 bin 里的 dll 复制到输出目录下面即可。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-keyword">extern</span> <span class="hljs-string">&quot;C&quot;</span> &#123;<br>    <span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;libavcodec/avcodec.h&gt;</span></span><br>    <span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;libavformat/avformat.h&gt;</span></span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>&#123;<br>    AVFormatContext* avFormatContext = <span class="hljs-built_in">avformat_alloc_context</span>();<br>    <span class="hljs-keyword">if</span> (avFormatContext == <span class="hljs-literal">nullptr</span>) &#123;<br>        std::cout &lt;&lt; <span class="hljs-string">&quot;avFormatContext is nullptr&quot;</span> &lt;&lt; std::endl;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        std::cout &lt;&lt; <span class="hljs-string">&quot;avFormatContext is not nullptr&quot;</span> &lt;&lt; std::endl;<br>    &#125;<br>    <span class="hljs-built_in">avformat_free_context</span>(avFormatContext);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>运行正常输出：</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">avcodec_alloc_context success<br></code></pre></td></tr></table></figure><p>以上。</p>]]></content>
    
    
    
    <tags>
      
      <tag>C++</tag>
      
      <tag>音视频处理</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>记一次运算符优先级导致的 ROS 服务执行逻辑不符预期的问题</title>
    <link href="/2025/02/20/%E8%AE%B0%E4%B8%80%E6%AC%A1-ROS-%E6%9C%8D%E5%8A%A1%E6%89%A7%E8%A1%8C%E9%80%BB%E8%BE%91%E4%B8%8D%E7%AC%A6%E9%A2%84%E6%9C%9F%E7%9A%84%E9%97%AE%E9%A2%98/"/>
    <url>/2025/02/20/%E8%AE%B0%E4%B8%80%E6%AC%A1-ROS-%E6%9C%8D%E5%8A%A1%E6%89%A7%E8%A1%8C%E9%80%BB%E8%BE%91%E4%B8%8D%E7%AC%A6%E9%A2%84%E6%9C%9F%E7%9A%84%E9%97%AE%E9%A2%98/</url>
    
    <content type="html"><![CDATA[<p><strong>按：这文章我自己写出来都想笑。绕了一大圈发现错误无比简单。</strong></p><h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>几天前，我一位室友 A 君在做学校某竞赛小组的入组考核项目。此项目其中一个子任务的要求如下：</p><ul><li><p>有一个服务端 Ser；</p></li><li><p>有两个客户端 Cli1，Cli2；</p></li><li><p>Cli1 和 Cli2 会各自向 Ser 发送一个数字，但是发送顺序未知；</p></li><li><p>Ser 需要将两数的加和返回给 Cli1 和Cli2。</p></li></ul><p>设计上采用了状态机：共计三个状态，Send、Polling 和 Fetched。对于客户端 CliX，默认处于 Send 状态，发送数字给 Ser 后进入 Polling 状态轮询计算结果，服务端会返回一个新的状态——如果计算好了就是 Fetched 附带结果，否则还是 Polling。</p><h2 id="问题发生"><a href="#问题发生" class="headerlink" title="问题发生"></a>问题发生</h2><p>服务端用一个计数器来维护目前获得的数字数量。计数器不会重置，只会对 2 求余判断是不是两个数字都被获取了。如果是，就会重置加和值。</p><p>这部分我帮 A 君做了，然后求余的地方故意装了个小X用的按位和。结果跑起来发现逻辑不对：那个 if branch 根本没有进去，里面的重置加和值的逻辑也没有执行，这是为什么？</p><p>可以看一下伪代码：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-type">int</span> fetchCounter = <span class="hljs-number">0</span>;<br><br><span class="hljs-type">int</span> sum = <span class="hljs-number">0</span>;<br><span class="hljs-type">int</span> sumCounter = <span class="hljs-number">0</span>;<br><br><br><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">callBack</span><span class="hljs-params">(Request&amp; req, Response&amp; resp)</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (req.clientState == State::SEND) &#123;<br>        sum += req.num;<br>        sumCounter ++;<br>        resp.newState = State::POLLING;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (req.clientState == State::POLLING) &#123;<br>        <span class="hljs-keyword">if</span> (sumCounter % <span class="hljs-number">2</span> == <span class="hljs-number">0</span>) &#123;<br>            resp.newState = State::FETCHED;<br>            resp.sum = sum;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            resp.newState = State::POLLING;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (req.clientState == State::FETCHED) &#123;<br>        fetchCounter ++;<br>        resp.newState = State::SEND;<br><br>        <span class="hljs-comment">/* 从这个地方…… */</span><br>        <span class="hljs-keyword">if</span> (fetchCounter &amp; <span class="hljs-number">1</span> == <span class="hljs-number">0</span>) &#123;<br>            sum = <span class="hljs-number">0</span>;<br>        &#125;<br>        <span class="hljs-comment">/* ……到这个地方都没执行 */</span><br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>是啊，所以到底为什么呢？</p><h2 id="排错"><a href="#排错" class="headerlink" title="排错"></a>排错</h2><p>首先打了几个 <code>ROS_INFO</code> 进去，进行比较没慧根的调试。发现那个 if 分支确实无论如何都不会被执行。所以我怀疑这一整个 if 都被优化掉了，打开 Compiler Explorer 看看吧。</p><p>上述问题代码可以写成以下简化形式：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-type">int</span> a = <span class="hljs-number">0</span>; <br><span class="hljs-type">int</span> b;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span> <span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (a &amp; <span class="hljs-number">1</span> == <span class="hljs-number">0</span>) &#123;<br>        b = <span class="hljs-number">0</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>使用 gcc 14.2 生成得到以下汇编代码：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs nasm">a:<br>        .zero   4<br>b:<br>        .zero   4<br>main:<br>        pushq   %rbp<br>        movq    %rsp, %rbp<br>        movl    $0, %eax<br>        popq    %rbp<br>        ret<br></code></pre></td></tr></table></figure><p>可以看到 if 分支确实没了。那我缺的逻辑这块谁给我补啊？</p><p>一开始我怀疑是因为计数器默认是 0 然后编译器进行静态优化了，而且 callBack 函数基本上是放在 the middle of nowhere，可能编译器误判了，以为计数器不会被更新？那这也太夸张了吧。</p><p>那传统派呢？</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-type">int</span> a = <span class="hljs-number">0</span>; <br><span class="hljs-type">int</span> b;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span> <span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (a % <span class="hljs-number">2</span> == <span class="hljs-number">0</span>) &#123;<br>        b = <span class="hljs-number">2</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>得到以下代码：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs nasm">a:<br>        .zero   4<br>b:<br>        .zero   4<br>main:<br>        pushq   %rbp<br>        movq    %rsp, %rbp<br>        movl    a(%rip), %eax<br>        andl    $1, %eax<br>        testl   %eax, %eax<br>        jne     .L2<br>        movl    $2, b(%rip)<br>.L2:<br>        movl    $0, %eax<br>        popq    %rbp<br>        ret<br></code></pre></td></tr></table></figure><p>怎么又正常了？莫非对位运算和对求模的优化策略还不一样？</p><p>结果最后是什么原因呢……</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-type">int</span> a = <span class="hljs-number">0</span>; <br><span class="hljs-type">int</span> b;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span> <span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> ((a &amp; <span class="hljs-number">1</span>) == <span class="hljs-number">0</span>) &#123;<br>        b = <span class="hljs-number">2</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>此代码得到结果正常。</p><p>居然是沟槽的运算符优先级……首先这个 <code>== 0</code> 就比较挫，用一个 <code>!</code> 解决的事情，不知道当时为什么这么写了，错误还很隐蔽……</p><p><code>1 == 0</code> 先结合了得到 0，然后 <code>a &amp; 0</code> 恒等于 0，编译器自然是要优化掉这块的啦……</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>出这种问题确实有点笨蛋了。不过运算符优先级这种事情我之前确实没太深究过。真的会有人为了考试去嗯背那个吗？</p>]]></content>
    
    
    
    <tags>
      
      <tag>C++</tag>
      
      <tag>ROS</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Hello World</title>
    <link href="/2025/02/19/hello-world/"/>
    <url>/2025/02/19/hello-world/</url>
    
    <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ hexo new <span class="hljs-string">&quot;My New Post&quot;</span><br></code></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/writing.html">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ hexo server<br></code></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/server.html">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ hexo generate<br></code></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/generating.html">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ hexo deploy<br></code></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>]]></content>
    
    
    
  </entry>
  
  
  
  
</search>
